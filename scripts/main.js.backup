const menuToggle = document.getElementById('menuToggle');
const menuFlotante = document.getElementById('menuFlotante');
const configToggle = document.getElementById('configToggle');
const configMenu = document.getElementById('configMenu');
const logoLeftInput = document.getElementById('logoLeftInput');
const logoRightInput = document.getElementById('logoRightInput');
const previewLogoLeft = document.getElementById('previewLogoLeft');
const previewLogoRight = document.getElementById('previewLogoRight');
const removeLogosBtn = document.getElementById('removeLogosBtn');
const restoreLogosBtn = document.getElementById('restoreLogosBtn');
const uploadLogosBtn = document.getElementById('uploadLogosBtn');
const bulkLogoInput = document.getElementById('bulkLogoInput');
const defaultColorInput = document.getElementById('defaultColorInput');
const showNumbersInput = document.getElementById('showNumbersInput');
const aplicarConfig = document.getElementById('aplicarConfig');
const guardarConfig = document.getElementById('guardarConfig');
const configPiloto = document.getElementById('configPiloto');
const configFecha = document.getElementById('configFecha');
const configCentro = document.getElementById('configCentro');
const reiniciarBitacora = document.getElementById('reiniciarBitacora');
const guardarPlantilla = document.getElementById('guardarPlantilla');
const cargarPlantilla = document.getElementById('cargarPlantilla');
const gestionarPlantillas = document.getElementById('gestionarPlantillas');
const exportarBackup = document.getElementById('exportarBackup');
const importarBackup = document.getElementById('importarBackup');
const inputBackup = document.getElementById('inputBackup');
const lineaInput = document.getElementById('lineaInput');
const lineaEstado = document.getElementById('lineaEstado');
const vistaPrevia = document.getElementById('vistaPrevia');
const crearInforme = document.getElementById('crearInforme');
const agregarTextoEsquema = document.getElementById('agregarTextoEsquema');
const cargarFotosMenu = document.getElementById('cargarFotosMenu');
const nuevoInforme = document.getElementById('nuevoInforme');
const addBitacoraBtn = document.getElementById('addBitacoraBtn');
const panelLineas = document.getElementById('panelLineas');
const inputFotosGlobal = document.getElementById('inputFotosGlobal');
const labelAgregarFotos = document.getElementById('labelAgregarFotos');
const guardarInforme = document.getElementById('guardarInforme');
const verConsolidado = document.getElementById('verConsolidado');
const verEstadisticas = document.getElementById('verEstadisticas');
const verRecordatorios = document.getElementById('verRecordatorios');
const badgeRecordatorios = document.getElementById('badgeRecordatorios');
const exportarPDF = document.getElementById('exportarPDF');
const verEstadoCache = document.getElementById('verEstadoCache');
const limpiarCachePWA = document.getElementById('limpiarCachePWA');
const verEstadoSync = document.getElementById('verEstadoSync');
const forzarSync = document.getElementById('forzarSync');
const limpiarColaSync = document.getElementById('limpiarColaSync');

// Inputs para datos del informe
const inputPiloto = document.getElementById('inputPiloto');
const inputFecha = document.getElementById('inputFecha');
const inputJaula = document.getElementById('inputJaula');
const inputArea = document.getElementById('inputArea');

let imagenLineaActual = null;
let contadorNumerosFotos = 1; // Contador global para mantener numeraci√≥n continua

// Overlay para cerrar paneles
const overlayPanel = document.getElementById('overlayPanel');

// Settings (persistidos en localStorage)
const DEFAULT_SETTINGS = { 
  defaultColor: '#1976d2', 
  showNumbers: true, 
  logoLeft: null, 
  logoRight: null,
  pilotoDefault: 'Ronald Ya√±ez',
  fechaDefault: '29-10-2025',
  centroDefault: ''
};
let settings = loadSettings();

function loadSettings() {
  try {
    const raw = localStorage.getItem('reporteSettings');
    if (raw) return JSON.parse(raw);
  } catch (e) {
    // ignore
  }
  return { ...DEFAULT_SETTINGS };
}

function saveSettings() {
  try {
    localStorage.setItem('reporteSettings', JSON.stringify(settings));
  } catch (e) {
    console.warn('No se pudo guardar settings', e);
  }
}

  // ===== Crear bit√°cora inicial autom√°ticamente
  function crearBitacoraInicial() {
    const hoja = document.createElement('div');
    hoja.className = 'hoja-bitacora hoja-fotos';
    hoja.id = 'bitacora-principal';

    // encabezado usando settings (si existen) o assets por defecto
    const encabezado = document.createElement('div');
    encabezado.className = 'encabezado-hoja';
    const leftLogo = settings.logoLeft || 'assets/logo-izquierdo.png';
    const rightLogo = settings.logoRight || 'assets/logo-derecho.png';
    encabezado.innerHTML = `
      <div class="encabezado-fila">
        <img src="${leftLogo}" class="logo-izq" alt="Logo Izquierdo" />
        <div class="encabezado-texto">
          <h2>Bit√°cora de Inspecci√≥n</h2>
          <p>Registro diario</p>
        </div>
        <img src="${rightLogo}" class="logo-der" alt="Logo Derecho" />
      </div>
    `;
    hoja.appendChild(encabezado);

    // contenido: tabla que replica la estructura de la imagen
    const contenido = document.createElement('div');
    contenido.className = 'bloque-fotos';
    contenido.innerHTML = `
      <div class="hoja-bitacora-contenido">
        <table class="tabla-bitacora">
          <thead>
            <tr class="top-header">
              <th rowspan="2">Dia Turno</th>
              <th rowspan="2">Fecha de informe</th>
              <th rowspan="2">Area de Inspeccion</th>
              <th colspan="3">Roturas</th>
              <th colspan="3">Objetos y/o Anomalias</th>
            </tr>
            <tr class="sub-header">
              <th>Informadas</th>
              <th>Reparadas</th>
              <th>Pendientes</th>
              <th>Informadas</th>
              <th>Reparadas</th>
              <th>Pendientes</th>
            </tr>
          </thead>
          <tbody>
            ${Array.from({ length: 15 }).map((_, i) => `
              <tr>
                <td class="numero-dia">${i + 1}</td>
                <td contenteditable="true" class="editable-cell" data-col="fecha"></td>
                <td contenteditable="true" class="editable-cell" data-col="area"></td>
                <td contenteditable="true" class="editable-cell" data-col="rot_informadas"></td>
                <td contenteditable="true" class="editable-cell" data-col="rot_reparadas"></td>
                <td contenteditable="true" class="editable-cell" data-col="rot_pendientes"></td>
                <td contenteditable="true" class="editable-cell" data-col="obj_informadas"></td>
                <td contenteditable="true" class="editable-cell" data-col="obj_reparadas"></td>
                <td contenteditable="true" class="editable-cell" data-col="obj_pendientes"></td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <div class="abrev">
          <p><strong>Abreviaturas en √°reas de Inspecci√≥n Loberos:</strong> CB (cabecera malla Lobera), FN (Fondo malla Lobera), LT (Lateral malla Lobera), MP (mamparo malla Lobera)</p>
          <p><strong>Abreviaturas en √°reas de Inspecci√≥n Peceras:</strong> CP (Cara de malla Pecera), FP (Fondo malla Pecera)</p>
        </div>
      </div>
    `;

    hoja.appendChild(contenido);
    return hoja;
  }

  // Insertar bit√°cora al final siempre
  function asegurarBitacoraAlFinal() {
    let bitacora = document.getElementById('bitacora-principal');
    if (!bitacora) {
      bitacora = crearBitacoraInicial();
    }
    // Mover al final del panelLineas
    panelLineas.appendChild(bitacora);
  }

  // Funci√≥n helper para insertar elementos antes de la bit√°cora de inspecci√≥n
  function insertarAntesBitacora(elemento) {
    const bitacora = document.getElementById('bitacora-principal');
    if (bitacora) {
      panelLineas.insertBefore(elemento, bitacora);
    } else {
      panelLineas.appendChild(elemento);
    }
  }

  // Crear bit√°cora inicial
  asegurarBitacoraAlFinal();

  // Observar cambios en panelLineas para mantener bit√°cora al final
  let observerActivo = true;
  let editandoBitacora = false;
  
  const observer = new MutationObserver((mutations) => {
    // No reaccionar si se est√° editando la bit√°cora
    if (editandoBitacora) return;
    
    // Solo reaccionar a adiciones/eliminaciones de nodos, no a cambios de texto
    const hayNodosNuevos = mutations.some(m => 
      m.addedNodes.length > 0 || m.removedNodes.length > 0
    );
    if (observerActivo && hayNodosNuevos) {
      observerActivo = false;
      setTimeout(() => {
        asegurarBitacoraAlFinal();
        observerActivo = true;
      }, 100);
    }
  });
  observer.observe(panelLineas, { childList: true, subtree: false });
  
  // Detectar cuando se est√° editando la bit√°cora
  document.addEventListener('focusin', (e) => {
    if (e.target.classList.contains('editable-cell')) {
      editandoBitacora = true;
    }
  });
  
  document.addEventListener('focusout', (e) => {
    if (e.target.classList.contains('editable-cell')) {
      // Peque√±o delay para permitir cambio entre celdas
      setTimeout(() => {
        if (!document.activeElement?.classList.contains('editable-cell')) {
          editandoBitacora = false;
        }
      }, 50);
    }
  });

  // ===== BOT√ìN: Agregar bit√°cora adicional si es necesario
  if (addBitacoraBtn) {
    addBitacoraBtn.addEventListener('click', () => {
      const hoja = document.createElement('div');
      hoja.className = 'hoja-bitacora hoja-fotos';

      const encabezado = document.createElement('div');
      encabezado.className = 'encabezado-hoja';
      const leftLogo = settings.logoLeft || 'assets/logo-izquierdo.png';
      const rightLogo = settings.logoRight || 'assets/logo-derecho.png';
      encabezado.innerHTML = `
        <div class="encabezado-fila">
          <img src="${leftLogo}" class="logo-izq" alt="Logo Izquierdo" />
          <div class="encabezado-texto">
            <h2>Bit√°cora de Inspecci√≥n</h2>
            <p>Registro diario</p>
          </div>
          <img src="${rightLogo}" class="logo-der" alt="Logo Derecho" />
        </div>
      `;
      hoja.appendChild(encabezado);

      const contenido = document.createElement('div');
      contenido.className = 'bloque-fotos';
      contenido.innerHTML = `
        <div class="hoja-bitacora-contenido">
          <table class="tabla-bitacora">
            <thead>
              <tr class="top-header">
                <th rowspan="2">Dia Turno</th>
                <th rowspan="2">Fecha de informe</th>
                <th rowspan="2">Area de Inspeccion</th>
                <th colspan="3">Roturas</th>
                <th colspan="3">Objetos y/o Anomalias</th>
              </tr>
              <tr class="sub-header">
                <th>Informadas</th>
                <th>Reparadas</th>
                <th>Pendientes</th>
                <th>Informadas</th>
                <th>Reparadas</th>
                <th>Pendientes</th>
              </tr>
            </thead>
            <tbody>
              ${Array.from({ length: 15 }).map((_, i) => `
                <tr>
                  <td class="numero-dia">${i + 1}</td>
                  <td contenteditable="true" class="editable-cell" data-col="fecha"></td>
                  <td contenteditable="true" class="editable-cell" data-col="area"></td>
                  <td contenteditable="true" class="editable-cell" data-col="rot_informadas"></td>
                  <td contenteditable="true" class="editable-cell" data-col="rot_reparadas"></td>
                  <td contenteditable="true" class="editable-cell" data-col="rot_pendientes"></td>
                  <td contenteditable="true" class="editable-cell" data-col="obj_informadas"></td>
                  <td contenteditable="true" class="editable-cell" data-col="obj_reparadas"></td>
                  <td contenteditable="true" class="editable-cell" data-col="obj_pendientes"></td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div class="abrev">
            <p><strong>Abreviaturas en √°reas de Inspecci√≥n Loberos:</strong> CB (cabecera malla Lobera), FN (Fondo malla Lobera), LT (Lateral malla Lobera), MP (mamparo malla Lobera)</p>
            <p><strong>Abreviaturas en √°reas de Inspecci√≥n Peceras:</strong> CP (Cara de malla Pecera), FP (Fondo malla Pecera)</p>
          </div>
        </div>
      `;

      hoja.appendChild(contenido);
      // Insertar antes de la bit√°cora principal para que la principal siempre est√© al final
      const bitacoraPrincipal = document.getElementById('bitacora-principal');
      if (bitacoraPrincipal) {
        panelLineas.insertBefore(hoja, bitacoraPrincipal);
      } else {
        panelLineas.appendChild(hoja);
      }
      applySettingsToUI();
      hoja.scrollIntoView({ behavior: 'smooth' });
    });
  }
// Aplicar settings a la UI: logos y comportamiento de n√∫meros
function applySettingsToUI() {
  // logos: si hay settings, aplicar a todas las instancias
  // if settings.logoLeft is an empty string => explicitly removed
  if (settings.logoLeft === '') {
    document.querySelectorAll('.logo-izq').forEach(img => img.src = '');
  } else if (settings.logoLeft) {
    document.querySelectorAll('.logo-izq').forEach(img => img.src = settings.logoLeft);
  }
  if (settings.logoRight === '') {
    document.querySelectorAll('.logo-der').forEach(img => img.src = '');
  } else if (settings.logoRight) {
    document.querySelectorAll('.logo-der').forEach(img => img.src = settings.logoRight);
  }

  // n√∫meros: color y visibilidad
  document.querySelectorAll('.numero-foto, .numero-interactivo').forEach(el => {
    el.style.backgroundColor = settings.defaultColor;
    el.style.display = settings.showNumbers ? '' : 'none';
  });

  // actualizar inputs UI si existen
  if (defaultColorInput) defaultColorInput.value = settings.defaultColor;
  if (showNumbersInput) showNumbersInput.checked = !!settings.showNumbers;
  if (previewLogoLeft && settings.logoLeft) previewLogoLeft.src = settings.logoLeft;
  if (previewLogoRight && settings.logoRight) previewLogoRight.src = settings.logoRight;
  
  // actualizar campos de configuraci√≥n de encabezado
  if (configPiloto) configPiloto.value = settings.pilotoDefault || DEFAULT_SETTINGS.pilotoDefault;
  if (configFecha) configFecha.value = settings.fechaDefault || DEFAULT_SETTINGS.fechaDefault;
  if (configCentro) configCentro.value = settings.centroDefault || DEFAULT_SETTINGS.centroDefault;
}

// init: almacenar src originales de logos para fallback
document.querySelectorAll('.logo-izq').forEach(img => {
  if (!img.dataset.originalSrc) img.dataset.originalSrc = img.src;
});
document.querySelectorAll('.logo-der').forEach(img => {
  if (!img.dataset.originalSrc) img.dataset.originalSrc = img.src;
});

// aplicar settings guardados al inicio
applySettingsToUI();

// ========== SINCRONIZACI√ìN DE ENCABEZADOS ==========
// Funci√≥n para sincronizar valores de encabezados entre todas las hojas
function sincronizarEncabezados(campo, valor) {
  document.querySelectorAll(`[data-sync="${campo}"]`).forEach(input => {
    if (input.value !== valor) {
      input.value = valor;
    }
  });
}

// Agregar event listeners para sincronizaci√≥n en tiempo real
document.addEventListener('input', (e) => {
  if (e.target.dataset.sync) {
    const campo = e.target.dataset.sync;
    const valor = e.target.value;
    sincronizarEncabezados(campo, valor);
  }
});

// ========== PROTECCI√ìN DE EDICI√ìN DE BIT√ÅCORA ==========
// Evitar que eventos interfieran con la edici√≥n de celdas de bit√°cora
document.addEventListener('click', (e) => {
  const celda = e.target.closest('.editable-cell');
  if (celda && celda.hasAttribute('contenteditable')) {
    // Asegurar que la celda reciba el foco
    if (document.activeElement !== celda) {
      celda.focus();
    }
  }
}, true); // Use capture phase

// Funci√≥n auxiliar para abrir/cerrar paneles
function abrirPanel(panel) {
  menuFlotante.classList.add('oculto');
  configMenu.classList.add('oculto');
  if (panel) {
    panel.classList.remove('oculto');
    overlayPanel.classList.remove('oculto');
  } else {
    overlayPanel.classList.add('oculto');
  }
}

function cerrarPaneles() {
  menuFlotante.classList.add('oculto');
  configMenu.classList.add('oculto');
  overlayPanel.classList.add('oculto');
}

// Cerrar paneles al hacer clic en el overlay
if (overlayPanel) {
  overlayPanel.addEventListener('click', cerrarPaneles);
}

menuToggle.addEventListener('click', () => {
  const estaAbierto = !menuFlotante.classList.contains('oculto');
  if (estaAbierto) {
    cerrarPaneles();
  } else {
    abrirPanel(menuFlotante);
  }
});

// Config menu toggle
if (configToggle && configMenu) {
  configToggle.addEventListener('click', () => {
    const estaAbierto = !configMenu.classList.contains('oculto');
    if (estaAbierto) {
      cerrarPaneles();
    } else {
      abrirPanel(configMenu);
    }
  });

  // Helpers para lectura de archivos y previews
  if (logoLeftInput) {
    logoLeftInput.addEventListener('change', () => {
      const f = logoLeftInput.files && logoLeftInput.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = (e) => {
        if (previewLogoLeft) previewLogoLeft.src = e.target.result;
        // no guardar a√∫n hasta que el usuario aplique/guarde
        previewLogoLeft.dataset.pending = e.target.result;
      };
      r.readAsDataURL(f);
    });
  }

  if (logoRightInput) {
    logoRightInput.addEventListener('change', () => {
      const f = logoRightInput.files && logoRightInput.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = (e) => {
        if (previewLogoRight) previewLogoRight.src = e.target.result;
        previewLogoRight.dataset.pending = e.target.result;
      };
      r.readAsDataURL(f);
    });
  }

  // Bot√≥n para subir logos en lote: abre un input multiple y asigna el primero al izquierdo y segundo al derecho
  if (uploadLogosBtn && bulkLogoInput) {
    uploadLogosBtn.addEventListener('click', () => {
      bulkLogoInput.value = null; // reset
      bulkLogoInput.click();
    });

    bulkLogoInput.addEventListener('change', () => {
      const files = bulkLogoInput.files ? Array.from(bulkLogoInput.files) : [];
      // file[0] -> left, file[1] -> right (si existen)
      if (files[0]) {
        const r = new FileReader();
        r.onload = (e) => {
          if (previewLogoLeft) previewLogoLeft.src = e.target.result;
          if (previewLogoLeft) previewLogoLeft.dataset.pending = e.target.result;
        };
        r.readAsDataURL(files[0]);
      }
      if (files[1]) {
        const r2 = new FileReader();
        r2.onload = (e) => {
          if (previewLogoRight) previewLogoRight.src = e.target.result;
          if (previewLogoRight) previewLogoRight.dataset.pending = e.target.result;
        };
        r2.readAsDataURL(files[1]);
      }
    });
  }

  // Quitar logos: dejar src vac√≠o y persistir si se desea
  if (removeLogosBtn) {
    removeLogosBtn.addEventListener('click', () => {
      // marcar como removidos
      settings.logoLeft = '';
      settings.logoRight = '';
      saveSettings();
      applySettingsToUI();
    });
  }

  // Restaurar originales (usar data-original-src guardado en el DOM)
  if (restoreLogosBtn) {
    restoreLogosBtn.addEventListener('click', () => {
      document.querySelectorAll('.logo-izq').forEach(img => {
        if (img.dataset.originalSrc) img.src = img.dataset.originalSrc;
      });
      document.querySelectorAll('.logo-der').forEach(img => {
        if (img.dataset.originalSrc) img.src = img.dataset.originalSrc;
      });
      // quitar cualquier logo guardado en settings para volver a originales
      settings.logoLeft = null;
      settings.logoRight = null;
      saveSettings();
      applySettingsToUI();
    });
  }

  // Aplicar sin guardar
  if (aplicarConfig) {
    aplicarConfig.addEventListener('click', () => {
      if (previewLogoLeft && previewLogoLeft.dataset.pending) settings.logoLeft = previewLogoLeft.dataset.pending;
      if (previewLogoRight && previewLogoRight.dataset.pending) settings.logoRight = previewLogoRight.dataset.pending;
      if (defaultColorInput) settings.defaultColor = defaultColorInput.value;
      if (showNumbersInput) settings.showNumbers = showNumbersInput.checked;
      if (configPiloto) settings.pilotoDefault = configPiloto.value;
      if (configFecha) settings.fechaDefault = configFecha.value;
      if (configCentro) settings.centroDefault = configCentro.value;
      applySettingsToUI();
    });
  }

  // Guardar y aplicar
  if (guardarConfig) {
    guardarConfig.addEventListener('click', () => {
      if (previewLogoLeft && previewLogoLeft.dataset.pending) settings.logoLeft = previewLogoLeft.dataset.pending;
      if (previewLogoRight && previewLogoRight.dataset.pending) settings.logoRight = previewLogoRight.dataset.pending;
      if (defaultColorInput) settings.defaultColor = defaultColorInput.value;
      if (showNumbersInput) settings.showNumbers = showNumbersInput.checked;
      if (configPiloto) settings.pilotoDefault = configPiloto.value;
      if (configFecha) settings.fechaDefault = configFecha.value;
      if (configCentro) settings.centroDefault = configCentro.value;
      saveSettings();
      applySettingsToUI();
      
      // Actualizar todos los encabezados existentes con los nuevos valores
      if (configPiloto && configPiloto.value) {
        document.querySelectorAll('[data-sync="piloto"]').forEach(input => {
          input.value = configPiloto.value;
        });
      }
      if (configFecha && configFecha.value) {
        document.querySelectorAll('[data-sync="fecha"]').forEach(input => {
          input.value = configFecha.value;
        });
      }
      if (configCentro && configCentro.value) {
        document.querySelectorAll('[data-sync="centro"]').forEach(input => {
          input.value = configCentro.value;
        });
      }
      
      cerrarPaneles();
    });
  }
  
  // Bot√≥n para reiniciar bit√°cora
  if (reiniciarBitacora) {
    reiniciarBitacora.addEventListener('click', () => {
      if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres reiniciar la bit√°cora? Se borrar√°n todos los datos ingresados.')) {
        // Limpiar localStorage
        localStorage.removeItem('bitacoraGuardada');
        
        // Limpiar todas las celdas de la bit√°cora actual
        const tablaBitacora = document.querySelector('.tabla-bitacora tbody');
        if (tablaBitacora) {
          tablaBitacora.querySelectorAll('tr').forEach(tr => {
            tr.querySelectorAll('td[contenteditable="true"]').forEach(td => {
              td.textContent = '';
              td.removeAttribute('data-value');
            });
          });
        }
        
        alert('‚úÖ Bit√°cora reiniciada correctamente');
        cerrarPaneles();
      }
    });
  }
  
  // ========== EVENT LISTENERS PARA PLANTILLAS ==========
  if (guardarPlantilla) {
    guardarPlantilla.addEventListener('click', guardarPlantillaBitacora);
  }
  
  if (cargarPlantilla) {
    cargarPlantilla.addEventListener('click', cargarPlantillaBitacora);
  }
  
  if (gestionarPlantillas) {
    gestionarPlantillas.addEventListener('click', gestionarPlantillasBitacora);
  }
  
  // ========== BOTONES DE MODO OFFLINE ==========
  if (verEstadoCache) {
    verEstadoCache.addEventListener('click', async () => {
      try {
        const estado = await obtenerEstadoCache();
        alert(`üìä Estado de Cach√©\n\n‚úÖ Recursos en cach√©: ${estado.cached}\nüì¶ Total de recursos: ${estado.total}\n\n${estado.cached > 0 ? '‚úÖ La aplicaci√≥n funciona offline' : '‚ö†Ô∏è A√∫n no hay recursos en cach√©'}`);
      } catch (e) {
        alert('‚ö†Ô∏è No se pudo obtener el estado de la cach√©');
      }
    });
  }
  
  if (limpiarCachePWA) {
    limpiarCachePWA.addEventListener('click', limpiarCache);
  }
  
  // ========== BOTONES DE SINCRONIZACI√ìN ==========
  if (verEstadoSync) {
    verEstadoSync.addEventListener('click', verEstadoSincronizacion);
  }
  
  if (forzarSync) {
    forzarSync.addEventListener('click', forzarSincronizacion);
  }
  
  if (limpiarColaSync) {
    limpiarColaSync.addEventListener('click', limpiarColaSincronizacion);
  }
  
  // ========== SISTEMA DE BACKUP ==========
  // Exportar backup completo
  if (exportarBackup) {
    exportarBackup.addEventListener('click', () => {
      try {
        const backup = {
          version: '1.0',
          fecha: new Date().toISOString(),
          informesGuardados: JSON.parse(localStorage.getItem('informesGuardados') || '[]'),
          bitacoraGuardada: JSON.parse(localStorage.getItem('bitacoraGuardada') || '[]'),
          borradorAutoguardado: JSON.parse(localStorage.getItem('borradorAutoguardado') || 'null'),
          settings: JSON.parse(localStorage.getItem('reporteSettings') || '{}'),
          recordatorios: JSON.parse(localStorage.getItem('recordatorios') || '[]'),
          plantillasBitacora: JSON.parse(localStorage.getItem('plantillasBitacora') || '[]')
        };
        
        const dataStr = JSON.stringify(backup, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup-informes-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        mostrarNotificacion('‚úÖ Backup descargado', 3000);
      } catch (e) {
        alert('‚ùå Error al crear backup: ' + e.message);
        console.error(e);
      }
    });
  }
  
  // Importar/Restaurar backup
  if (importarBackup && inputBackup) {
    importarBackup.addEventListener('click', () => {
      inputBackup.click();
    });
    
    inputBackup.addEventListener('change', () => {
      const archivo = inputBackup.files[0];
      if (!archivo) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const backup = JSON.parse(e.target.result);
          
          // Validar estructura del backup
          if (!backup.version || !backup.informesGuardados) {
            throw new Error('Formato de backup inv√°lido');
          }
          
          const confirmar = confirm(
            `üìÇ Restaurar Backup\n\n` +
            `Fecha del backup: ${new Date(backup.fecha).toLocaleString()}\n` +
            `Informes: ${backup.informesGuardados.length}\n\n` +
            `‚ö†Ô∏è ADVERTENCIA: Esto reemplazar√° todos los datos actuales.\n\n` +
            `¬øDeseas continuar?`
          );
          
          if (confirmar) {
            // Restaurar datos
            if (backup.informesGuardados) {
              localStorage.setItem('informesGuardados', JSON.stringify(backup.informesGuardados));
            }
            if (backup.bitacoraGuardada) {
              localStorage.setItem('bitacoraGuardada', JSON.stringify(backup.bitacoraGuardada));
            }
            if (backup.borradorAutoguardado) {
              localStorage.setItem('borradorAutoguardado', JSON.stringify(backup.borradorAutoguardado));
            }
            if (backup.settings) {
              localStorage.setItem('reporteSettings', JSON.stringify(backup.settings));
            }
            if (backup.recordatorios) {
              localStorage.setItem('recordatorios', JSON.stringify(backup.recordatorios));
            }
            if (backup.plantillasBitacora) {
              localStorage.setItem('plantillasBitacora', JSON.stringify(backup.plantillasBitacora));
            }
            
            mostrarNotificacion('‚úÖ Backup restaurado correctamente', 3000);
            
            setTimeout(() => {
              if (confirm('Se recomienda recargar la p√°gina para aplicar todos los cambios. ¬øRecargar ahora?')) {
                location.reload();
              }
            }, 1000);
          }
        } catch (e) {
          alert('‚ùå Error al restaurar backup: ' + e.message);
          console.error(e);
        }
      };
      
      reader.readAsText(archivo);
      inputBackup.value = ''; // Limpiar input
    });
  }
}

// ========== FUNCI√ìN DE COMPRESI√ìN DE IM√ÅGENES ==========
function comprimirImagen(base64String, maxWidth = 600, quality = 0.4) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      let width = img.width;
      let height = img.height;
      
      // Redimensionar si es necesario
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      // Comprimir a JPEG con calidad especificada
      const comprimida = canvas.toDataURL('image/jpeg', quality);
      resolve(comprimida);
    };
    img.src = base64String;
  });
}

lineaInput.addEventListener('change', () => {
  const archivo = lineaInput.files[0];
  if (archivo) {
    lineaEstado.textContent = `Imagen cargada: "${archivo.name}"`;
    const reader = new FileReader();
    reader.onload = function (e) {
      const imagenOriginal = e.target.result;
      
      // Preguntar si quiere recortar o usar completa
      if (confirm('¬øQuieres usar la imagen completa?\n\nOK = Usar completa\nCancelar = Recortar manualmente')) {
        // Usar imagen completa directamente
        imagenLineaActual = imagenOriginal;
        vistaPrevia.innerHTML = `<img src="${imagenLineaActual}" class="imagen-previa" />`;
        crearInforme.disabled = false;
        if (agregarTextoEsquema) agregarTextoEsquema.disabled = false;
        if (cargarFotosMenu) cargarFotosMenu.disabled = false;
        if (inputFotosGlobal) inputFotosGlobal.disabled = false;
        if (labelAgregarFotos) {
          labelAgregarFotos.style.cursor = 'pointer';
          labelAgregarFotos.style.opacity = '1';
          labelAgregarFotos.style.backgroundColor = '#ffffff';
          labelAgregarFotos.removeAttribute('disabled');
        }
      } else {
        // Mostrar editor de recorte
        mostrarEditorRecorte(imagenOriginal, (imagenRecortada) => {
          imagenLineaActual = imagenRecortada;
          vistaPrevia.innerHTML = `<img src="${imagenLineaActual}" class="imagen-previa" />`;
          crearInforme.disabled = false;
          if (agregarTextoEsquema) agregarTextoEsquema.disabled = false;
          if (cargarFotosMenu) cargarFotosMenu.disabled = false;
          if (inputFotosGlobal) inputFotosGlobal.disabled = false;
          if (labelAgregarFotos) {
            labelAgregarFotos.style.cursor = 'pointer';
            labelAgregarFotos.style.opacity = '1';
            labelAgregarFotos.style.backgroundColor = '#ffffff';
            labelAgregarFotos.removeAttribute('disabled');
          }
        });
      }
    };
    reader.readAsDataURL(archivo);
  } else {
    lineaEstado.textContent = 'No se ha seleccionado ninguna imagen';
    vistaPrevia.innerHTML = '';
    crearInforme.disabled = true;
    if (agregarTextoEsquema) agregarTextoEsquema.disabled = true;
    if (inputFotosGlobal) inputFotosGlobal.disabled = true;
    if (labelAgregarFotos) {
      labelAgregarFotos.style.cursor = 'not-allowed';
      labelAgregarFotos.style.opacity = '0.5';
      labelAgregarFotos.style.backgroundColor = '#f0f0f0';
      labelAgregarFotos.setAttribute('disabled', 'disabled');
    }
  }
});

crearInforme.addEventListener('click', () => {
  if (!imagenLineaActual) return;

  const idLinea = `linea-${Date.now()}`;
  let numerosDisponibles = [];

  // Obtener valores de los inputs o de configuraci√≥n guardada
  const piloto = inputPiloto ? inputPiloto.value || settings.pilotoDefault || 'Ronald Ya√±ez' : settings.pilotoDefault || 'Ronald Ya√±ez';
  const fecha = inputFecha ? inputFecha.value || settings.fechaDefault || '29-10-2025' : settings.fechaDefault || '29-10-2025';
  const centro = configCentro ? configCentro.value || settings.centroDefault || '' : settings.centroDefault || '';
  const jaula = inputJaula ? inputJaula.value || '102' : '102';
  const area = inputArea ? inputArea.value || 'CABECERA' : 'CABECERA';

  // ===== HOJA 1: L√çNEA =====
  const hojaLinea = document.createElement('div');
  hojaLinea.className = 'hoja-fotos';

  const encabezadoLinea = document.createElement('div');
  encabezadoLinea.className = 'encabezado-hoja';
  const leftLogo = settings.logoLeft || 'assets/logo-izquierdo.png';
  const rightLogo = settings.logoRight || 'assets/logo-derecho.png';
  encabezadoLinea.innerHTML = `
    <div class="encabezado-fila">
      <img src="${leftLogo}" class="logo-izq" alt="Logo Izquierdo" />
      <div class="encabezado-texto">
        <h2>Informe de Inspecci√≥n Submarina</h2>
        <div style="display:flex; gap:15px; justify-content:center; margin-bottom:4px; flex-wrap:wrap;">
          <p style="margin:0;"><strong>Piloto ROV:</strong> <input type="text" class="encabezado-input sync-piloto" data-sync="piloto" value="${piloto}" readonly style="border:none; background:transparent; font-weight:normal; width:auto; min-width:120px; cursor:default;" /></p>
          <p style="margin:0;"><strong>Fecha:</strong> <input type="text" class="encabezado-input sync-fecha" data-sync="fecha" value="${fecha}" readonly style="border:none; background:transparent; font-weight:normal; width:auto; min-width:100px; cursor:default;" /></p>
          <p style="margin:0;"><strong>Centro de Cultivo:</strong> <input type="text" class="encabezado-input sync-centro" data-sync="centro" value="${centro}" readonly style="border:none; background:transparent; font-weight:normal; width:auto; min-width:140px; cursor:default;" /></p>
        </div>
        <p style="text-align:center; margin:0;"><strong>√Årea:</strong> <input type="text" class="encabezado-input sync-area" data-sync="area" value="${area} - JAULA N.¬∫${jaula}" style="border:none; background:transparent; font-weight:normal; width:auto; min-width:180px;" /></p>
      </div>
      <img src="${rightLogo}" class="logo-der" alt="Logo Derecho" />
    </div>
  `;
  hojaLinea.appendChild(encabezadoLinea);

  const bloqueLinea = document.createElement('div');
  bloqueLinea.className = 'bloque-fotos';
  bloqueLinea.innerHTML = `
    <div class="linea-final" style="position: relative !important; display: flex !important; justify-content: center !important; align-items: center !important;">
      <div class="imagen-wrapper" style="position: relative !important; display: inline-block !important; max-width: 100% !important;">
        <img src="${imagenLineaActual}" class="linea-imagen" style="width: 100% !important; height: auto !important; max-height: 600px !important; object-fit: contain !important; display: block !important;" />
      </div>
      <button class="btn-cambiar-esquema" title="Cambiar esquema">üîÑ Cambiar Esquema</button>
      <input type="file" accept="image/*" class="input-cambiar-esquema" style="display:none;" />
    </div>
  `;
  hojaLinea.appendChild(bloqueLinea);
  
  // Funcionalidad para cambiar el esquema
  const btnCambiarEsquema = bloqueLinea.querySelector('.btn-cambiar-esquema');
  const inputCambiarEsquema = bloqueLinea.querySelector('.input-cambiar-esquema');
  const imgEsquema = bloqueLinea.querySelector('.linea-imagen');
  
  btnCambiarEsquema.addEventListener('click', () => {
    inputCambiarEsquema.click();
  });
  
  inputCambiarEsquema.addEventListener('change', (e) => {
    const archivo = e.target.files[0];
    if (archivo) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        const imagenOriginal = ev.target.result;
        
        // Preguntar si quiere recortar o usar completa
        if (confirm('¬øQuieres usar la imagen completa?\n\nOK = Usar completa\nCancelar = Recortar manualmente')) {
          // Usar imagen completa directamente
          imgEsquema.src = imagenOriginal;
          imagenLineaActual = imagenOriginal;
        } else {
          // Mostrar editor de recorte
          mostrarEditorRecorte(imagenOriginal, (imagenRecortada) => {
            imgEsquema.src = imagenRecortada;
            imagenLineaActual = imagenRecortada;
          });
        }
      };
      reader.readAsDataURL(archivo);
    }
  });
  
  const inputContainer = document.createElement('div');
  inputContainer.className = 'contenedor-cargar-fotos';
  inputContainer.innerHTML = `
    <div class="upload-area-fotos">
      <label for="${idLinea}-input" class="upload-label-fotos">
        <div class="upload-icon">üì∑</div>
        <div class="upload-text">
          <span class="upload-title">Cargar fotos para esta l√≠nea</span>
          <span class="upload-subtitle">Selecciona hasta 9 im√°genes por hoja</span>
        </div>
      </label>
      <input type="file" accept="image/*" multiple id="${idLinea}-input" class="input-file-hidden" />
    </div>
  `;
  hojaLinea.appendChild(inputContainer);
  insertarAntesBitacora(hojaLinea);
  
  // Habilitar los botones despu√©s de crear el informe
  if (agregarTextoEsquema) agregarTextoEsquema.disabled = false;
  if (cargarFotosMenu) cargarFotosMenu.disabled = false;
  
  const inputFotos = inputContainer.querySelector(`#${idLinea}-input`);
  const lineaFinal = bloqueLinea.querySelector('.linea-final');
  const imagenWrapper = bloqueLinea.querySelector('.imagen-wrapper');

  let contadorLocal = 1; // Contador local para n√∫meros interactivos en esta l√≠nea

  // Agregar event listener ANTES de restaurar bit√°cora
  inputFotos.addEventListener('change', (event) => {
    console.log('Evento change disparado, archivos:', inputFotos.files.length);
    const archivos = Array.from(inputFotos.files);
    
    if (archivos.length === 0) {
      console.log('No se seleccionaron archivos');
      return;
    }
    
    console.log('Procesando archivos:', archivos.map(a => a.name));
    
    const lectores = archivos.map((archivo) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = async function (e) {
          // Comprimir la imagen antes de agregarla (600px, calidad 40%)
          const imagenComprimida = await comprimirImagen(e.target.result, 600, 0.4);
          resolve({ src: imagenComprimida, nombre: archivo.name });
        };
        reader.readAsDataURL(archivo);
      });
    });

    Promise.all(lectores).then((imagenes) => {
      console.log('Todas las im√°genes cargadas:', imagenes.length);
      // crear hojas separadas, m√°ximo 9 fotos por hoja (3x3)
      const grupos = [];
      for (let i = 0; i < imagenes.length; i += 9) {
        grupos.push(imagenes.slice(i, i + 9));
      }
      
      console.log('Grupos de fotos:', grupos.length, 'grupos');

      grupos.forEach((grupo, paginaIndex) => {
        console.log(`Creando hoja ${paginaIndex + 1} con ${grupo.length} fotos`);
        const hojaGrupo = document.createElement('div');
        hojaGrupo.className = 'hoja-fotos';

        const encabez = document.createElement('div');
        encabez.className = 'encabezado-hoja';
        const leftLogo = settings.logoLeft || 'assets/logo-izquierdo.png';
        const rightLogo = settings.logoRight || 'assets/logo-derecho.png';
        encabez.innerHTML = `
          <div class="encabezado-fila">
            <img src="${leftLogo}" class="logo-izq" alt="Logo Izquierdo" />
            <div class="encabezado-texto">
              <h2>Informe de Inspecci√≥n Submarina</h2>
              <div style="display:flex; gap:15px; justify-content:center; margin-bottom:4px; flex-wrap:wrap;">
                <p style="margin:0;"><strong>Piloto ROV:</strong> <input type="text" class="encabezado-input sync-piloto" data-sync="piloto" value="${piloto}" readonly style="border:none; background:transparent; font-weight:normal; width:auto; min-width:120px; cursor:default;" /></p>
                <p style="margin:0;"><strong>Fecha:</strong> <input type="text" class="encabezado-input sync-fecha" data-sync="fecha" value="${fecha}" readonly style="border:none; background:transparent; font-weight:normal; width:auto; min-width:100px; cursor:default;" /></p>
                <p style="margin:0;"><strong>Centro de Cultivo:</strong> <input type="text" class="encabezado-input sync-centro" data-sync="centro" value="${centro}" readonly style="border:none; background:transparent; font-weight:normal; width:auto; min-width:140px; cursor:default;" /></p>
              </div>
              <p style="text-align:center; margin:0;"><strong>√Årea:</strong> <input type="text" class="encabezado-input sync-area" data-sync="area" value="${area} - JAULA N.¬∫${jaula}" style="border:none; background:transparent; font-weight:normal; width:auto; min-width:180px;" /></p>
            </div>
            <img src="${rightLogo}" class="logo-der" alt="Logo Derecho" />
          </div>
        `;
        hojaGrupo.appendChild(encabez);

        const bloque = document.createElement('div');
        bloque.className = 'bloque-fotos';

        const contenedorPagina = document.createElement('div');
        contenedorPagina.className = 'hoja-galeria';

        grupo.forEach(({ src, nombre }, i) => {
          const contenedor = document.createElement('div');
          contenedor.className = 'foto-contenedor';

          const numeroGlobal = paginaIndex * 6 + i + 1;

          contenedor.innerHTML = `
            <div class="numero-foto">${numeroGlobal}</div>
            <div class="controles-foto">
              <button class="btn-eliminar" title="Eliminar foto">üóëÔ∏è</button>
              <button class="btn-cambiar" title="Cambiar foto">üîÑ</button>
            </div>
            <img src="${src}" class="foto-informe" />
            <textarea class="descripcion-foto">${generarDescripcion(nombre)}</textarea>
          `;

          const numeroFoto = contenedor.querySelector('.numero-foto');
          if (numeroFoto) {
            numeroFoto.style.backgroundColor = settings.defaultColor;
            numeroFoto.style.display = settings.showNumbers ? '' : 'none';
          }

          if (numeroFoto) {
            const cicloColores = ['#1976d2', '#d32f2f', '#fbc02d', '#388e3c'];
            let idxInicial = cicloColores.indexOf(numeroFoto.style.backgroundColor);
            if (idxInicial === -1) {
              idxInicial = cicloColores.indexOf(settings.defaultColor);
              if (idxInicial === -1) idxInicial = 0;
              numeroFoto.style.backgroundColor = cicloColores[idxInicial];
            }
            numeroFoto.dataset.colorIndex = String(idxInicial);

            numeroFoto.addEventListener('click', (e) => {
              e.stopPropagation();
              const current = parseInt(numeroFoto.dataset.colorIndex || '0', 10);
              const next = (current + 1) % cicloColores.length;
              numeroFoto.dataset.colorIndex = String(next);
              numeroFoto.style.backgroundColor = cicloColores[next];
            });
          }

          // Bot√≥n eliminar
          const btnEliminar = contenedor.querySelector('.btn-eliminar');
          if (btnEliminar) {
            btnEliminar.addEventListener('click', (e) => {
              e.stopPropagation();
              contenedor.remove();
              // Renumerar fotos restantes
              const fotos = contenedorPagina.querySelectorAll('.foto-contenedor');
              fotos.forEach((foto, index) => {
                const numero = foto.querySelector('.numero-foto');
                if (numero) numero.textContent = index + 1;
              });
            });
          }

          // Bot√≥n cambiar
          const btnCambiar = contenedor.querySelector('.btn-cambiar');
          const imgFoto = contenedor.querySelector('.foto-informe');
          if (btnCambiar && imgFoto) {
            btnCambiar.addEventListener('click', (e) => {
              e.stopPropagation();
              const inputFile = document.createElement('input');
              inputFile.type = 'file';
              inputFile.accept = 'image/*';
              inputFile.addEventListener('change', () => {
                if (inputFile.files && inputFile.files[0]) {
                  const reader = new FileReader();
                  reader.onload = (ev) => {
                    imgFoto.src = ev.target.result;
                  };
                  reader.readAsDataURL(inputFile.files[0]);
                }
              });
              inputFile.click();
            });
          }

          contenedorPagina.appendChild(contenedor);
        });

        bloque.appendChild(contenedorPagina);
        hojaGrupo.appendChild(bloque);
        insertarAntesBitacora(hojaGrupo);

        Sortable.create(contenedorPagina, {
          animation: 150,
          onEnd: () => {
            const fotos = contenedorPagina.querySelectorAll('.foto-contenedor');
            fotos.forEach((foto, index) => {
              const numero = foto.querySelector('.numero-foto');
              numero.textContent = index + 1;
            });
          }
        });
      });

      inputFotos.value = '';
    });
  });

  imagenWrapper.addEventListener('click', (e) => {
    // Evitar agregar n√∫meros si se hace clic en una caja de texto o sus elementos
    if (e.target.classList.contains('caja-texto-esquema') || 
        e.target.classList.contains('btn-eliminar-texto-esquema') ||
        e.target.closest('.caja-texto-esquema')) {
      return;
    }
    
    // Obtener la posici√≥n relativa al wrapper de la imagen
    const rect = imagenWrapper.getBoundingClientRect();
    
    // Usar offsetX y offsetY que son relativos al elemento clickeado
    let x = e.offsetX;
    let y = e.offsetY;
    
    // Si el click fue en la imagen, ajustar al wrapper
    if (e.target.classList.contains('linea-imagen')) {
      // offsetX/Y ya es correcto para la imagen
      x = e.offsetX;
      y = e.offsetY;
    }
    
    console.log('Click en:', e.clientX, e.clientY);
    console.log('Offset:', e.offsetX, e.offsetY);
    console.log('Posici√≥n calculada:', x, y);

    const numeroAsignado = numerosDisponibles.length > 0
      ? numerosDisponibles.shift()
      : contadorLocal++;

    const grupoNumero = document.createElement('div');
    grupoNumero.className = 'grupo-numero';
    grupoNumero.style.left = `${x}px`;
    grupoNumero.style.top = `${y}px`;

    const numero = document.createElement('div');
    numero.className = 'numero-interactivo';
    numero.textContent = numeroAsignado;
    numero.style.backgroundColor = settings.defaultColor;
    numero.style.display = settings.showNumbers ? '' : 'none';

    const colorPicker = document.createElement('div');
    colorPicker.className = 'color-picker-interactivo oculto';
    colorPicker.innerHTML = `
      <button class="color-btn" data-color="#1976d2" style="background-color:#1976d2;"></button>
      <button class="color-btn" data-color="#d32f2f" style="background-color:#d32f2f;"></button>
      <button class="color-btn" data-color="#fbc02d" style="background-color:#fbc02d;"></button>
      <button class="color-btn" data-color="#388e3c" style="background-color:#388e3c;"></button>
    `;

    grupoNumero.appendChild(numero);
    grupoNumero.appendChild(colorPicker);
    grupoNumero.style.position = 'absolute';
    grupoNumero.style.transform = 'translate(-50%, -50%)';
    grupoNumero.style.zIndex = 10;

    grupoNumero.addEventListener('mouseenter', () => {
      colorPicker.classList.remove('oculto');
    });

    grupoNumero.addEventListener('mouseleave', () => {
      colorPicker.classList.add('oculto');
    });

    const botonesColor = colorPicker.querySelectorAll('.color-btn');
    botonesColor.forEach(btn => {
      btn.addEventListener('click', (event) => {
        event.stopPropagation();
        numero.style.backgroundColor = btn.dataset.color;
      });
    });

    numero.addEventListener('click', (ev) => {
      ev.stopPropagation();
      numerosDisponibles.push(numeroAsignado);
      numerosDisponibles.sort((a, b) => a - b);
      grupoNumero.remove();
    });

    imagenWrapper.appendChild(grupoNumero);
  });

  // Restaurar bit√°cora despu√©s de crear el informe y configurar todos los listeners
  setTimeout(() => {
    restaurarBitacora();
  }, 100);

  imagenLineaActual = null;
  vistaPrevia.innerHTML = '';
  lineaEstado.textContent = 'No se ha seleccionado ninguna imagen';
  crearInforme.disabled = true;
  cerrarPaneles();
});

function generarDescripcion(nombreArchivo) {
  const nombre = nombreArchivo.toUpperCase();
  const jaula = nombre.match(/JAULA(\d+)/);
  const profundidad = nombre.match(/(\d+)M/);

  const partes = [];
  if (jaula) partes.push(`Jaula: ${jaula[1]}`);
  if (profundidad) partes.push(`Profundidad: ${profundidad[0]}`);

  return partes.length ? partes.join(' | ') : '';
}

// ========== SISTEMA DE GUARDADO Y CONSOLIDADO DE INFORMES ==========

// Guardar bit√°cora en localStorage antes de guardar informe
function guardarBitacora() {
  const tablaBitacora = document.querySelector('.tabla-bitacora tbody');
  if (tablaBitacora) {
    const filas = [];
    tablaBitacora.querySelectorAll('tr').forEach(tr => {
      const celdas = Array.from(tr.querySelectorAll('td')).map(td => {
        // Capturar textContent o innerText de las celdas editables
        return td.textContent.trim();
      });
      filas.push(celdas);
    });
    localStorage.setItem('bitacoraGuardada', JSON.stringify(filas));
    console.log('Bit√°cora guardada:', filas); // Debug
  }
}

// Sincronizar contenido editable al DOM antes de guardar
function sincronizarBitacoraAlDOM() {
  const tablaBitacora = document.querySelector('.tabla-bitacora tbody');
  if (tablaBitacora) {
    tablaBitacora.querySelectorAll('tr').forEach(tr => {
      tr.querySelectorAll('td[contenteditable="true"]').forEach(td => {
        // Forzar que el textContent se refleje en el HTML
        const contenido = td.textContent;
        td.setAttribute('data-value', contenido);
        td.textContent = contenido;
      });
    });
  }
}

// ========== SISTEMA DE PLANTILLAS DE BIT√ÅCORA ==========

// Guardar plantilla de bit√°cora
function guardarPlantillaBitacora() {
  const nombrePlantilla = prompt('üíæ Nombre de la plantilla:', 'Plantilla ' + (new Date().toLocaleDateString()));
  
  if (!nombrePlantilla || nombrePlantilla.trim() === '') {
    return;
  }
  
  // Obtener datos actuales de la bit√°cora
  const datosGuardados = localStorage.getItem('bitacoraGuardada');
  if (!datosGuardados) {
    alert('‚ö†Ô∏è No hay datos de bit√°cora para guardar como plantilla.');
    return;
  }
  
  try {
    const filas = JSON.parse(datosGuardados);
    
    // Obtener plantillas existentes
    const plantillasGuardadas = JSON.parse(localStorage.getItem('plantillasBitacora') || '[]');
    
    // Crear nueva plantilla
    const nuevaPlantilla = {
      id: Date.now(),
      nombre: nombrePlantilla.trim(),
      fecha: new Date().toLocaleDateString(),
      datos: filas
    };
    
    plantillasGuardadas.push(nuevaPlantilla);
    localStorage.setItem('plantillasBitacora', JSON.stringify(plantillasGuardadas));
    
    mostrarNotificacion('‚úÖ Plantilla guardada: ' + nombrePlantilla, 3000);
  } catch (e) {
    alert('‚ùå Error al guardar la plantilla');
    console.error(e);
  }
}

// Cargar plantilla de bit√°cora
function cargarPlantillaBitacora() {
  const plantillasGuardadas = JSON.parse(localStorage.getItem('plantillasBitacora') || '[]');
  
  if (plantillasGuardadas.length === 0) {
    alert('üìÅ No hay plantillas guardadas. Guarda una primero.');
    return;
  }
  
  // Crear modal de selecci√≥n
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;';
  
  const contenido = document.createElement('div');
  contenido.style.cssText = 'background:#fff; padding:30px; border-radius:12px; max-width:600px; width:100%; max-height:80vh; overflow-y:auto;';
  
  contenido.innerHTML = `
    <h2 style="margin:0 0 20px 0; color:#1976d2; display:flex; align-items:center; gap:12px;">
      <span style="font-size:28px;">üìã</span>
      Cargar Plantilla
    </h2>
    <div id="listaPlantillas" style="display:flex; flex-direction:column; gap:12px; margin-bottom:20px;">
      ${plantillasGuardadas.map(plantilla => `
        <div class="item-plantilla" data-id="${plantilla.id}" style="background:#f5f5f5; padding:16px; border-radius:8px; cursor:pointer; transition:all 0.2s; border:2px solid transparent;">
          <div style="font-weight:600; font-size:16px; margin-bottom:4px; color:#333;">${plantilla.nombre}</div>
          <div style="font-size:13px; color:#666;">üìÖ Creada: ${plantilla.fecha} ‚Ä¢ ${plantilla.datos.length} filas</div>
        </div>
      `).join('')}
    </div>
    <button id="cancelarCarga" style="width:100%; padding:12px; background:#757575; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">‚ùå Cancelar</button>
  `;
  
  modal.appendChild(contenido);
  document.body.appendChild(modal);
  
  // Hover effects
  contenido.querySelectorAll('.item-plantilla').forEach(item => {
    item.addEventListener('mouseenter', () => {
      item.style.background = '#e3f2fd';
      item.style.borderColor = '#1976d2';
      item.style.transform = 'scale(1.02)';
    });
    item.addEventListener('mouseleave', () => {
      item.style.background = '#f5f5f5';
      item.style.borderColor = 'transparent';
      item.style.transform = 'scale(1)';
    });
    item.addEventListener('click', () => {
      const plantillaId = parseInt(item.dataset.id);
      const plantilla = plantillasGuardadas.find(p => p.id === plantillaId);
      if (plantilla && confirm(`¬ø Cargar la plantilla "${plantilla.nombre}"?\n\nEsto reemplazar√° los datos actuales de la bit√°cora.`)) {
        cargarDatosPlantilla(plantilla.datos);
        modal.remove();
        mostrarNotificacion('‚úÖ Plantilla cargada: ' + plantilla.nombre, 3000);
      }
    });
  });
  
  contenido.querySelector('#cancelarCarga').addEventListener('click', () => {
    modal.remove();
  });
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
}

// Cargar datos de plantilla en la bit√°cora
function cargarDatosPlantilla(datos) {
  try {
    const tablaBitacora = document.querySelector('.tabla-bitacora tbody');
    if (!tablaBitacora) return;
    
    tablaBitacora.querySelectorAll('tr').forEach((tr, idx) => {
      if (datos[idx]) {
        tr.querySelectorAll('td').forEach((td, colIdx) => {
          if (datos[idx][colIdx] && datos[idx][colIdx].trim() !== '') {
            td.textContent = datos[idx][colIdx];
            td.setAttribute('data-value', datos[idx][colIdx]);
          } else {
            td.textContent = '';
            td.removeAttribute('data-value');
          }
        });
      }
    });
    
    // Guardar en localStorage
    localStorage.setItem('bitacoraGuardada', JSON.stringify(datos));
  } catch (e) {
    alert('‚ùå Error al cargar la plantilla');
    console.error(e);
  }
}

// Gestionar plantillas (ver, eliminar)
function gestionarPlantillasBitacora() {
  const plantillasGuardadas = JSON.parse(localStorage.getItem('plantillasBitacora') || '[]');
  
  if (plantillasGuardadas.length === 0) {
    alert('üìÅ No hay plantillas guardadas.');
    return;
  }
  
  // Crear modal de gesti√≥n
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;';
  
  const contenido = document.createElement('div');
  contenido.style.cssText = 'background:#fff; padding:30px; border-radius:12px; max-width:700px; width:100%; max-height:80vh; overflow-y:auto;';
  
  function renderizarLista() {
    const plantillas = JSON.parse(localStorage.getItem('plantillasBitacora') || '[]');
    
    contenido.innerHTML = `
      <h2 style="margin:0 0 20px 0; color:#1976d2; display:flex; align-items:center; gap:12px;">
        <span style="font-size:28px;">‚öôÔ∏è</span>
        Gestionar Plantillas
      </h2>
      
      ${plantillas.length === 0 ? `
        <div style="text-align:center; padding:40px 20px; color:#999;">
          <div style="font-size:48px; margin-bottom:12px;">üìÅ</div>
          <div style="font-size:16px;">No hay plantillas guardadas</div>
        </div>
      ` : `
        <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:20px;">
          ${plantillas.map(plantilla => `
            <div style="background:#f5f5f5; padding:16px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
              <div style="flex:1;">
                <div style="font-weight:600; font-size:16px; margin-bottom:4px; color:#333;">${plantilla.nombre}</div>
                <div style="font-size:13px; color:#666;">üìÖ ${plantilla.fecha} ‚Ä¢ ${plantilla.datos.length} filas ‚Ä¢ ID: ${plantilla.id}</div>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="btn-ver" data-id="${plantilla.id}" style="padding:8px 16px; background:#2196f3; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">üëÅÔ∏è Ver</button>
                <button class="btn-eliminar" data-id="${plantilla.id}" style="padding:8px 16px; background:#f44336; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">üóëÔ∏è Eliminar</button>
              </div>
            </div>
          `).join('')}
        </div>
      `}
      
      <button id="cerrarGestion" style="width:100%; padding:12px; background:#757575; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">‚úîÔ∏è Cerrar</button>
    `;
    
    // Event listeners para botones
    contenido.querySelectorAll('.btn-eliminar').forEach(btn => {
      btn.addEventListener('click', () => {
        const plantillaId = parseInt(btn.dataset.id);
        const plantilla = plantillas.find(p => p.id === plantillaId);
        if (plantilla && confirm(`¬ø Eliminar la plantilla "${plantilla.nombre}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
          const nuevasPlantillas = plantillas.filter(p => p.id !== plantillaId);
          localStorage.setItem('plantillasBitacora', JSON.stringify(nuevasPlantillas));
          mostrarNotificacion('üóëÔ∏è Plantilla eliminada', 2000);
          renderizarLista();
        }
      });
    });
    
    contenido.querySelectorAll('.btn-ver').forEach(btn => {
      btn.addEventListener('click', () => {
        const plantillaId = parseInt(btn.dataset.id);
        const plantilla = plantillas.find(p => p.id === plantillaId);
        if (plantilla) {
          mostrarDetallesPlantilla(plantilla);
        }
      });
    });
    
    contenido.querySelector('#cerrarGestion').addEventListener('click', () => {
      modal.remove();
    });
  }
  
  renderizarLista();
  modal.appendChild(contenido);
  document.body.appendChild(modal);
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
}

// Mostrar detalles de una plantilla
function mostrarDetallesPlantilla(plantilla) {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; display:flex; align-items:center; justify-content:center; padding:20px;';
  
  const contenido = document.createElement('div');
  contenido.style.cssText = 'background:#fff; padding:30px; border-radius:12px; max-width:800px; width:100%; max-height:85vh; overflow-y:auto;';
  
  // Contar datos √∫tiles
  const filasConDatos = plantilla.datos.filter(fila => fila.some(celda => celda && celda.trim() !== ''));
  const areasUnicas = [...new Set(plantilla.datos.filter(f => f[2]).map(f => f[2]))];
  
  contenido.innerHTML = `
    <h2 style="margin:0 0 20px 0; color:#1976d2; display:flex; align-items:center; gap:12px;">
      <span style="font-size:28px;">üìä</span>
      ${plantilla.nombre}
    </h2>
    
    <div style="background:#f5f5f5; padding:16px; border-radius:8px; margin-bottom:20px;">
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px;">
        <div>
          <div style="font-size:13px; color:#666; margin-bottom:4px;">üìÖ Fecha de creaci√≥n</div>
          <div style="font-weight:600; color:#333;">${plantilla.fecha}</div>
        </div>
        <div>
          <div style="font-size:13px; color:#666; margin-bottom:4px;">üìä Total de filas</div>
          <div style="font-weight:600; color:#333;">${plantilla.datos.length}</div>
        </div>
        <div>
          <div style="font-size:13px; color:#666; margin-bottom:4px;">‚úÖ Filas con datos</div>
          <div style="font-weight:600; color:#333;">${filasConDatos.length}</div>
        </div>
        <div>
          <div style="font-size:13px; color:#666; margin-bottom:4px;">üìç √Åreas incluidas</div>
          <div style="font-weight:600; color:#333;">${areasUnicas.length}</div>
        </div>
      </div>
    </div>
    
    ${areasUnicas.length > 0 ? `
      <div style="background:#f5f5f5; padding:16px; border-radius:8px; margin-bottom:20px;">
        <h3 style="margin:0 0 12px 0; font-size:16px; color:#333;">üìç √Åreas configuradas:</h3>
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
          ${areasUnicas.map(area => `
            <span style="background:#1976d2; color:white; padding:6px 12px; border-radius:16px; font-size:13px;">${area}</span>
          `).join('')}
        </div>
      </div>
    ` : ''}
    
    <div style="background:#f9f9f9; padding:16px; border-radius:8px; max-height:300px; overflow-y:auto; margin-bottom:20px;">
      <h3 style="margin:0 0 12px 0; font-size:16px; color:#333;">üìù Vista previa de datos:</h3>
      <table style="width:100%; font-size:12px; border-collapse:collapse;">
        <thead>
          <tr style="background:#e0e0e0;">
            <th style="padding:8px; text-align:left; border:1px solid #ccc;">#</th>
            <th style="padding:8px; text-align:left; border:1px solid #ccc;">D√≠a/Turno</th>
            <th style="padding:8px; text-align:left; border:1px solid #ccc;">Fecha</th>
            <th style="padding:8px; text-align:left; border:1px solid #ccc;">√Årea</th>
            <th style="padding:8px; text-align:center; border:1px solid #ccc;" colspan="3">Roturas</th>
            <th style="padding:8px; text-align:center; border:1px solid #ccc;" colspan="3">Anomal√≠as</th>
          </tr>
          <tr style="background:#f0f0f0;">
            <th style="padding:4px; border:1px solid #ccc;"></th>
            <th style="padding:4px; border:1px solid #ccc;"></th>
            <th style="padding:4px; border:1px solid #ccc;"></th>
            <th style="padding:4px; border:1px solid #ccc;"></th>
            <th style="padding:4px; font-size:10px; border:1px solid #ccc;">Inf</th>
            <th style="padding:4px; font-size:10px; border:1px solid #ccc;">Rep</th>
            <th style="padding:4px; font-size:10px; border:1px solid #ccc;">Pen</th>
            <th style="padding:4px; font-size:10px; border:1px solid #ccc;">Inf</th>
            <th style="padding:4px; font-size:10px; border:1px solid #ccc;">Rep</th>
            <th style="padding:4px; font-size:10px; border:1px solid #ccc;">Pen</th>
          </tr>
        </thead>
        <tbody>
          ${filasConDatos.slice(0, 10).map((fila, idx) => `
            <tr style="${idx % 2 === 0 ? 'background:#fff;' : 'background:#f9f9f9;'}">
              ${fila.map((celda, colIdx) => `
                <td style="padding:6px; border:1px solid #ddd; ${colIdx >= 3 ? 'text-align:center;' : ''}">${celda || '-'}</td>
              `).join('')}
            </tr>
          `).join('')}
          ${filasConDatos.length > 10 ? `
            <tr><td colspan="10" style="padding:8px; text-align:center; color:#999; font-style:italic;">... y ${filasConDatos.length - 10} filas m√°s</td></tr>
          ` : ''}
        </tbody>
      </table>
    </div>
    
    <div style="display:flex; gap:12px;">
      <button id="cargarEstaPlantilla" style="flex:1; padding:12px; background:#4caf50; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">‚úÖ Cargar esta plantilla</button>
      <button id="cerrarDetalles" style="flex:1; padding:12px; background:#757575; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">‚ùå Cerrar</button>
    </div>
  `;
  
  modal.appendChild(contenido);
  document.body.appendChild(modal);
  
  contenido.querySelector('#cargarEstaPlantilla').addEventListener('click', () => {
    if (confirm(`¬ø Cargar la plantilla "${plantilla.nombre}"?\n\nEsto reemplazar√° los datos actuales de la bit√°cora.`)) {
      cargarDatosPlantilla(plantilla.datos);
      modal.remove();
      mostrarNotificacion('‚úÖ Plantilla cargada: ' + plantilla.nombre, 3000);
    }
  });
  
  contenido.querySelector('#cerrarDetalles').addEventListener('click', () => {
    modal.remove();
  });
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
}

// Restaurar bit√°cora desde localStorage
function restaurarBitacora() {
  const datosGuardados = localStorage.getItem('bitacoraGuardada');
  if (datosGuardados) {
    try {
      const filas = JSON.parse(datosGuardados);
      console.log('Restaurando bit√°cora:', filas); // Debug
      const tablaBitacora = document.querySelector('.tabla-bitacora tbody');
      if (tablaBitacora && filas.length > 0) {
        tablaBitacora.querySelectorAll('tr').forEach((tr, idx) => {
          if (filas[idx]) {
            tr.querySelectorAll('td').forEach((td, colIdx) => {
              if (filas[idx][colIdx] && filas[idx][colIdx].trim() !== '') {
                td.textContent = filas[idx][colIdx];
                td.setAttribute('data-value', filas[idx][colIdx]);
              }
            });
          }
        });
        console.log('Bit√°cora restaurada correctamente');
      }
    } catch (e) {
      console.error('Error al restaurar bit√°cora:', e);
    }
  }
}

// Guardar informe del d√≠a actual
function guardarInformeDiario() {
  // ========== VALIDACI√ìN DE CAMPOS OBLIGATORIOS ==========
  const errores = [];
  
  // Validar que haya contenido
  if (!panelLineas.innerHTML || panelLineas.innerHTML.trim() === '') {
    errores.push('‚Ä¢ No hay contenido para guardar');
  }
  
  // Validar que exista al menos una hoja (esquema o foto)
  const hojas = panelLineas.querySelectorAll('.hoja-fotos, .hoja-esquema');
  if (hojas.length === 0) {
    errores.push('‚Ä¢ Debes crear al menos una hoja de informe');
  }
  
  // Validar que haya un piloto configurado
  const pilotoInputs = panelLineas.querySelectorAll('[data-sync="piloto"]');
  const piloto = pilotoInputs.length > 0 ? pilotoInputs[0].value : '';
  if (!piloto || piloto.trim() === '') {
    errores.push('‚Ä¢ Falta configurar el nombre del Piloto ROV (ve a Configuraci√≥n)');
  }
  
  // Validar que haya una fecha configurada
  const fechaInputs = panelLineas.querySelectorAll('[data-sync="fecha"]');
  const fecha = fechaInputs.length > 0 ? fechaInputs[0].value : '';
  if (!fecha || fecha.trim() === '') {
    errores.push('‚Ä¢ Falta configurar la fecha (ve a Configuraci√≥n)');
  }
  
  // Validar que haya al menos un √°rea especificada
  const areaInputs = panelLineas.querySelectorAll('[data-sync="area"]');
  const area = areaInputs.length > 0 ? areaInputs[0].value : '';
  if (!area || area.trim() === '') {
    errores.push('‚Ä¢ Falta especificar el √Årea de inspecci√≥n');
  }
  
  // Mostrar errores si los hay
  if (errores.length > 0) {
    const mensaje = '‚ö†Ô∏è No se puede guardar el informe:\n\n' + errores.join('\n');
    alert(mensaje);
    return;
  }
  
  // Sincronizar bit√°cora al DOM antes de guardar
  sincronizarBitacoraAlDOM();
  
  // Guardar la bit√°cora antes de guardar el informe
  guardarBitacora();
  
  // Verificar si estamos en modo edici√≥n
  const editandoIdx = guardarInforme.dataset.editandoIdx;
  
  if (editandoIdx !== undefined) {
    // Modo actualizaci√≥n
    const idx = parseInt(editandoIdx);
    try {
      const informes = JSON.parse(localStorage.getItem('informesGuardados') || '[]');
      
      if (idx >= 0 && idx < informes.length) {
        const nombreActual = informes[idx].nombre;
        const confirmarNombre = prompt('Confirmar nombre del informe:', nombreActual);
        
        if (!confirmarNombre) {
          // Cancelar actualizaci√≥n
          delete guardarInforme.dataset.editandoIdx;
          guardarInforme.textContent = 'üíæ Guardar';
          guardarInforme.style.background = '';
          return;
        }
        
        // Actualizar informe existente
        informes[idx] = {
          ...informes[idx],
          nombre: confirmarNombre,
          contenido: panelLineas.innerHTML,
          timestamp: Date.now()
        };
        
        localStorage.setItem('informesGuardados', JSON.stringify(informes));
        alert(`‚úÖ Informe "${confirmarNombre}" actualizado exitosamente`);
        
        // Salir del modo edici√≥n
        delete guardarInforme.dataset.editandoIdx;
        guardarInforme.textContent = 'üíæ Guardar';
        guardarInforme.style.background = '';
      }
    } catch (e) {
      alert('‚ùå Error al actualizar el informe');
      console.error(e);
    }
  } else {
    // Modo guardar nuevo
    const fecha = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    const nombreInforme = prompt('Nombre del informe (opcional):', `Informe ${fecha}`);
    if (!nombreInforme) return;

    // Comprimir contenido antes de guardar
    let contenidoAGuardar = panelLineas.innerHTML;
    
    // Comprimir im√°genes base64 si son muy grandes
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = contenidoAGuardar;
    const imagenes = tempDiv.querySelectorAll('img');
    let imagenesComprimidas = 0;
    
    imagenes.forEach(img => {
      if (img.src && img.src.startsWith('data:image') && img.src.length > 100000) {
        // Imagen muy grande, marcar para advertencia pero no comprimir aqu√≠
        // ya que la compresi√≥n requiere canvas y es as√≠ncrona
        imagenesComprimidas++;
      }
    });
    
    const informe = {
      fecha: fecha,
      nombre: nombreInforme,
      timestamp: Date.now(),
      contenido: contenidoAGuardar
    };

    try {
      const informes = JSON.parse(localStorage.getItem('informesGuardados') || '[]');
      informes.push(informe);
      
      const jsonString = JSON.stringify(informes);
      const sizeInMB = (jsonString.length / (1024 * 1024)).toFixed(2);
      
      // Verificar tama√±o antes de guardar
      if (jsonString.length > 4500000) { // ~4.5MB (localStorage l√≠mite es ~5MB)
        throw new Error(`El informe es demasiado grande (${sizeInMB} MB). Intenta con menos im√°genes o im√°genes m√°s peque√±as.`);
      }
      
      localStorage.setItem('informesGuardados', jsonString);
      
      // Agregar a cola de sincronizaci√≥n
      agregarAColaSincronizacion({
        type: 'GUARDAR_INFORME',
        data: informe
      });
      
      let mensaje = `‚úÖ Informe "${nombreInforme}" guardado exitosamente`;
      if (sizeInMB > 3) {
        mensaje += `\n\n‚ö†Ô∏è Tama√±o: ${sizeInMB} MB. Considera usar menos im√°genes para futuros informes.`;
      }
      alert(mensaje);
      
      // No limpiar el contenido, mantener todo visible incluyendo la bit√°cora
      // La bit√°cora ya est√° guardada en localStorage y permanece en pantalla
    } catch (e) {
      console.error(e);
      alert('‚ùå Error al guardar el informe.\n\n' + 
            'El contenido es demasiado grande para localStorage.\n\n' +
            'üí° Sugerencias:\n' +
            '‚Ä¢ Usa menos im√°genes por informe\n' +
            '‚Ä¢ Reduce la resoluci√≥n de las im√°genes antes de cargarlas\n' +
            '‚Ä¢ Divide el informe en m√∫ltiples partes m√°s peque√±as\n\n' +
            'Puedes exportar a PDF sin problemas.');
    }
  }
}

// Ver y gestionar consolidado
// Restaurar event listeners despu√©s de cargar un informe guardado
function restaurarEventListenersInforme() {
  // Primero restaurar event listeners para n√∫meros EXISTENTES
  const gruposNumeroExistentes = document.querySelectorAll('.grupo-numero');
  gruposNumeroExistentes.forEach(grupoNumero => {
    const numero = grupoNumero.querySelector('.numero-interactivo');
    const colorPicker = grupoNumero.querySelector('.color-picker-interactivo');
    
    if (numero && colorPicker) {
      // Restaurar hover para mostrar/ocultar color picker
      grupoNumero.addEventListener('mouseenter', () => {
        colorPicker.classList.remove('oculto');
      });

      grupoNumero.addEventListener('mouseleave', () => {
        colorPicker.classList.add('oculto');
      });

      // Restaurar botones de color
      const botonesColor = colorPicker.querySelectorAll('.color-btn');
      botonesColor.forEach(btn => {
        btn.addEventListener('click', (event) => {
          event.stopPropagation();
          numero.style.backgroundColor = btn.dataset.color;
        });
      });

      // Restaurar click para eliminar
      numero.addEventListener('click', (ev) => {
        ev.stopPropagation();
        if (confirm('¬øEliminar este n√∫mero?')) {
          grupoNumero.remove();
        }
      });
    }
  });
  
  // Restaurar event listeners para crear nuevos n√∫meros en el esquema
  const imagenesWrapper = document.querySelectorAll('.imagen-wrapper');
  
  imagenesWrapper.forEach(imagenWrapper => {
    // Encontrar el n√∫mero m√°s alto existente para continuar el correlativo
    let numeroMasAlto = 0;
    const numerosExistentes = imagenWrapper.querySelectorAll('.numero-interactivo');
    numerosExistentes.forEach(numElem => {
      const valor = parseInt(numElem.textContent) || 0;
      if (valor > numeroMasAlto) {
        numeroMasAlto = valor;
      }
    });
    
    let contadorLocal = numeroMasAlto + 1;
    
    imagenWrapper.addEventListener('click', (e) => {
      // Evitar agregar n√∫meros si se hace clic en una caja de texto o sus elementos
      if (e.target.classList.contains('caja-texto-esquema') || 
          e.target.classList.contains('btn-eliminar-texto-esquema') ||
          e.target.closest('.caja-texto-esquema') ||
          e.target.classList.contains('grupo-numero') ||
          e.target.closest('.grupo-numero') ||
          e.target.classList.contains('numero-interactivo') ||
          e.target.classList.contains('color-btn')) {
        return;
      }
      
      // Obtener la posici√≥n relativa al wrapper de la imagen
      let x = e.offsetX;
      let y = e.offsetY;
      
      // Si el click fue en la imagen, ajustar al wrapper
      if (e.target.classList.contains('linea-imagen')) {
        x = e.offsetX;
        y = e.offsetY;
      }

      const numeroAsignado = contadorLocal++;

      const grupoNumero = document.createElement('div');
      grupoNumero.className = 'grupo-numero';
      grupoNumero.style.left = `${x}px`;
      grupoNumero.style.top = `${y}px`;

      const numero = document.createElement('div');
      numero.className = 'numero-interactivo';
      numero.textContent = numeroAsignado;
      numero.style.backgroundColor = settings.defaultColor;
      numero.style.display = settings.showNumbers ? '' : 'none';

      const colorPicker = document.createElement('div');
      colorPicker.className = 'color-picker-interactivo oculto';
      colorPicker.innerHTML = `
        <button class="color-btn" data-color="#1976d2" style="background-color:#1976d2;"></button>
        <button class="color-btn" data-color="#d32f2f" style="background-color:#d32f2f;"></button>
        <button class="color-btn" data-color="#fbc02d" style="background-color:#fbc02d;"></button>
        <button class="color-btn" data-color="#388e3c" style="background-color:#388e3c;"></button>
      `;

      grupoNumero.appendChild(numero);
      grupoNumero.appendChild(colorPicker);
      grupoNumero.style.position = 'absolute';
      grupoNumero.style.transform = 'translate(-50%, -50%)';
      grupoNumero.style.zIndex = 10;

      grupoNumero.addEventListener('mouseenter', () => {
        colorPicker.classList.remove('oculto');
      });

      grupoNumero.addEventListener('mouseleave', () => {
        colorPicker.classList.add('oculto');
      });

      const botonesColor = colorPicker.querySelectorAll('.color-btn');
      botonesColor.forEach(btn => {
        btn.addEventListener('click', (event) => {
          event.stopPropagation();
          numero.style.backgroundColor = btn.dataset.color;
        });
      });

      numero.addEventListener('click', (ev) => {
        ev.stopPropagation();
        if (confirm('¬øEliminar este n√∫mero?')) {
          grupoNumero.remove();
        }
      });

      imagenWrapper.appendChild(grupoNumero);
    });
  });
  
  // Restaurar event listeners para cajas de texto
  const cajasTexto = document.querySelectorAll('.caja-texto-esquema');
  cajasTexto.forEach(caja => {
    const btnEliminar = caja.querySelector('.btn-eliminar-texto-esquema');
    if (btnEliminar) {
      btnEliminar.addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm('¬øEliminar esta caja de texto?')) {
          caja.remove();
        }
      });
    }
  });
  
  console.log('Event listeners restaurados para edici√≥n');
}

function verConsolidadoInformes() {
  try {
    const informes = JSON.parse(localStorage.getItem('informesGuardados') || '[]');
    
    if (informes.length === 0) {
      alert('No hay informes guardados.');
      return;
    }

    // Crear ventana modal con lista de informes
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center;';
    
    const contenido = document.createElement('div');
    contenido.style.cssText = 'background:#fff; padding:24px; border-radius:12px; max-width:800px; max-height:80vh; overflow-y:auto; width:90%;';
    
    contenido.innerHTML = `
      <h2 style="margin:0 0 20px 0; color:#1976d2; display:flex; align-items:center; gap:10px;">
        <span style="font-size:28px;">üìä</span>
        Informes Guardados (<span id="contadorInformes">${informes.length}</span>)
      </h2>
      
      <!-- Campo de b√∫squeda -->
      <div style="margin-bottom:16px;">
        <input type="text" id="buscarInforme" placeholder="üîç Buscar por nombre, fecha, piloto o √°rea..." style="width:100%; padding:10px 14px; border:2px solid #1976d2; border-radius:8px; font-size:14px; box-sizing:border-box;" />
      </div>
      
      <div style="margin-bottom:20px; display:flex; gap:10px;">
        <button id="generarConsolidadoBtn" style="padding:10px 20px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.2);">üìÑ Generar Consolidado</button>
        <button id="cerrarModalBtn" style="padding:10px 20px; background:#757575; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; box-shadow:0 2px 4px rgba(0,0,0,0.2);">‚úñÔ∏è Cerrar</button>
      </div>
      <div style="overflow-x:auto;">
        <table id="tablaInformes" style="width:100%; border-collapse:collapse; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:#fff;">
              <th style="padding:12px; text-align:left; border:1px solid #1565c0; font-weight:600;">Nombre</th>
              <th style="padding:12px; text-align:left; border:1px solid #1565c0; font-weight:600;">Fecha</th>
              <th style="padding:12px; text-align:center; border:1px solid #1565c0; font-weight:600; min-width:280px;">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyInformes">
            ${informes.map((inf, idx) => `
              <tr data-nombre="${inf.nombre.toLowerCase()}" data-fecha="${inf.fecha}" data-idx="${idx}" style="background:${idx % 2 === 0 ? '#fff' : '#f9f9f9'}; transition:background 0.2s;">
                <td style="padding:10px; border:1px solid #ddd; font-weight:500;">${inf.nombre}</td>
                <td style="padding:10px; border:1px solid #ddd;">${inf.fecha}</td>
                <td style="padding:10px; border:1px solid #ddd; text-align:center;">
                  <button class="cargar-informe-btn" data-idx="${idx}" style="padding:6px 12px; background:#4caf50; color:#fff; border:none; border-radius:4px; cursor:pointer; margin-right:4px; font-size:13px; font-weight:600; transition:background 0.2s;" onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4caf50'">üìÇ Cargar</button>
                  <button class="editar-informe-btn" data-idx="${idx}" style="padding:6px 12px; background:#2196f3; color:#fff; border:none; border-radius:4px; cursor:pointer; margin-right:4px; font-size:13px; font-weight:600; transition:background 0.2s;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196f3'">‚úèÔ∏è Editar</button>
                  <button class="eliminar-informe-btn" data-idx="${idx}" style="padding:6px 12px; background:#f44336; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:13px; font-weight:600; transition:background 0.2s;" onmouseover="this.style.background='#da190b'" onmouseout="this.style.background='#f44336'">üóëÔ∏è Eliminar</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      <div id="sinResultados" style="display:none; text-align:center; padding:40px; color:#999;">
        <p style="font-size:18px; margin:0;">üîç No se encontraron informes</p>
      </div>
    `;
    
    modal.appendChild(contenido);
    document.body.appendChild(modal);

    // Funci√≥n de b√∫squeda en tiempo real
    const inputBuscar = contenido.querySelector('#buscarInforme');
    const tbody = contenido.querySelector('#tbodyInformes');
    const contador = contenido.querySelector('#contadorInformes');
    const sinResultados = contenido.querySelector('#sinResultados');
    const tabla = contenido.querySelector('#tablaInformes');
    
    inputBuscar.addEventListener('input', () => {
      const termino = inputBuscar.value.toLowerCase().trim();
      const filas = tbody.querySelectorAll('tr');
      let visibles = 0;
      
      filas.forEach(fila => {
        const nombre = fila.dataset.nombre || '';
        const fecha = fila.dataset.fecha || '';
        const idx = fila.dataset.idx;
        const informe = informes[idx];
        
        // Buscar en nombre, fecha y contenido del informe
        const contenidoTexto = informe.contenido.toLowerCase();
        
        if (nombre.includes(termino) || 
            fecha.includes(termino) || 
            contenidoTexto.includes(termino)) {
          fila.style.display = '';
          visibles++;
        } else {
          fila.style.display = 'none';
        }
      });
      
      contador.textContent = visibles;
      
      if (visibles === 0) {
        tabla.style.display = 'none';
        sinResultados.style.display = 'block';
      } else {
        tabla.style.display = 'table';
        sinResultados.style.display = 'none';
      }
    });

    // Bot√≥n cerrar
    contenido.querySelector('#cerrarModalBtn').addEventListener('click', () => {
      modal.remove();
    });

    // Generar consolidado completo
    contenido.querySelector('#generarConsolidadoBtn').addEventListener('click', () => {
      generarConsolidadoCompleto(informes);
      modal.remove();
    });

    // Cargar informe individual
    contenido.querySelectorAll('.cargar-informe-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.dataset.idx);
        if (confirm('¬øCargar este informe? Se reemplazar√° el contenido actual.')) {
          panelLineas.innerHTML = informes[idx].contenido;
          alert('‚úÖ Informe cargado');
          modal.remove();
        }
      });
    });

    // Editar informe
    contenido.querySelectorAll('.editar-informe-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.dataset.idx);
        const informe = informes[idx];
        
        // Cargar el informe en el panel para editarlo
        panelLineas.innerHTML = informe.contenido;
        modal.remove();
        
        // Restaurar event listeners para poder editar
        restaurarEventListenersInforme();
        
        // Mostrar mensaje y opci√≥n de guardar cambios
        const confirmar = confirm(`‚úèÔ∏è Editando: "${informe.nombre}"\n\nRealiza los cambios necesarios y luego haz clic en "Guardar Informe" para actualizar.`);
        
        if (confirmar) {
          // Guardar referencia del √≠ndice para actualizar despu√©s
          guardarInforme.dataset.editandoIdx = idx;
          guardarInforme.textContent = 'üíæ Actualizar Informe';
          guardarInforme.style.background = '#ff9800';
        }
      });
    });

    // Eliminar informe
    contenido.querySelectorAll('.eliminar-informe-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.dataset.idx);
        const informeAEliminar = informes[idx];
        
        if (confirm('¬øEliminar este informe permanentemente?')) {
          informes.splice(idx, 1);
          localStorage.setItem('informesGuardados', JSON.stringify(informes));
          
          // Agregar a cola de sincronizaci√≥n
          agregarAColaSincronizacion({
            type: 'ELIMINAR_INFORME',
            data: { 
              id: informeAEliminar.timestamp, 
              nombre: informeAEliminar.nombre 
            }
          });
          
          alert('üóëÔ∏è Informe eliminado');
          modal.remove();
          verConsolidadoInformes(); // Reabrir con lista actualizada
        }
      });
    });

  } catch (e) {
    alert('‚ùå Error al cargar informes guardados');
    console.error(e);
  }
}

// Generar consolidado completo
function generarConsolidadoCompleto(informes) {
  // Limpiar panel actual
  panelLineas.innerHTML = '';
  
  // Agregar cada informe al panel directamente sin separador
  informes.forEach((inf, idx) => {
    const contenedor = document.createElement('div');
    contenedor.innerHTML = inf.contenido;
    
    // Si no es el primer informe, agregar page-break al primer elemento
    if (idx > 0) {
      const primerHoja = contenedor.querySelector('.hoja-indice, .hoja-bitacora, .hoja-fotos, .hoja-esquema');
      if (primerHoja) {
        primerHoja.style.pageBreakBefore = 'always';
      }
    }
    
    panelLineas.appendChild(contenedor);
  });

  alert(`‚úÖ Consolidado generado con ${informes.length} informes`);
}

// ========== DASHBOARD DE ESTAD√çSTICAS ==========
function verEstadisticasInformes() {
  try {
    const informes = JSON.parse(localStorage.getItem('informesGuardados') || '[]');
    
    if (informes.length === 0) {
      alert('No hay informes guardados para analizar.');
      return;
    }

    // Analizar datos de los informes
    const stats = analizarDatosInformes(informes);
    
    // Crear modal
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center; overflow-y:auto; padding:20px;';
    
    const contenido = document.createElement('div');
    contenido.style.cssText = 'background:#fff; padding:30px; border-radius:12px; max-width:1000px; width:100%; max-height:90vh; overflow-y:auto;';
    
    contenido.innerHTML = `
      <h2 style="margin:0 0 24px 0; color:#1976d2; display:flex; align-items:center; gap:12px;">
        <span style="font-size:32px;">üìä</span>
        Dashboard de Estad√≠sticas
      </h2>
      
      <!-- Resumen general -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:24px;">
        <div style="background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:white; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
          <div style="font-size:36px; font-weight:bold; margin-bottom:8px;">${stats.totalInformes}</div>
          <div style="font-size:14px; opacity:0.9;">Total de Informes</div>
        </div>
        
        <div style="background:linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color:white; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
          <div style="font-size:36px; font-weight:bold; margin-bottom:8px;">${stats.totalRoturas}</div>
          <div style="font-size:14px; opacity:0.9;">Total Roturas</div>
        </div>
        
        <div style="background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color:white; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
          <div style="font-size:36px; font-weight:bold; margin-bottom:8px;">${stats.totalAnomalias}</div>
          <div style="font-size:14px; opacity:0.9;">Total Anomal√≠as</div>
        </div>
        
        <div style="background:linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color:white; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
          <div style="font-size:36px; font-weight:bold; margin-bottom:8px;">${stats.promedioRoturas}</div>
          <div style="font-size:14px; opacity:0.9;">Promedio Roturas/D√≠a</div>
        </div>
      </div>
      
      <!-- √Åreas m√°s problem√°ticas -->
      <div style="background:#f5f5f5; padding:20px; border-radius:8px; margin-bottom:24px;">
        <h3 style="margin:0 0 16px 0; color:#333; font-size:18px;">üéØ √Åreas M√°s Problem√°ticas</h3>
        <div style="display:grid; gap:8px;">
          ${stats.areasMasProblematicas.slice(0, 5).map((area, idx) => `
            <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:12px 16px; border-radius:6px; border-left:4px solid ${['#f44336', '#ff5722', '#ff9800', '#ffc107', '#ffeb3b'][idx]};">
              <span style="font-weight:500;">${area.nombre}</span>
              <span style="background:${['#f44336', '#ff5722', '#ff9800', '#ffc107', '#ffeb3b'][idx]}; color:white; padding:4px 12px; border-radius:12px; font-size:13px; font-weight:600;">${area.incidencias} incidencias</span>
            </div>
          `).join('')}
        </div>
      </div>
      
      <!-- Tendencia por per√≠odo -->
      <div style="background:#f5f5f5; padding:20px; border-radius:8px; margin-bottom:24px;">
        <h3 style="margin:0 0 16px 0; color:#333; font-size:18px;">üìà √öltimos ${Math.min(stats.tendenciaDias.length, 10)} D√≠as</h3>
        <div style="display:flex; gap:8px; align-items:flex-end; height:200px;">
          ${stats.tendenciaDias.slice(-10).map((dia, idx) => {
            const maxRoturas = Math.max(...stats.tendenciaDias.map(d => d.roturas), 1);
            const altura = (dia.roturas / maxRoturas) * 160;
            return `
              <div style="flex:1; display:flex; flex-direction:column; align-items:center; gap:8px;">
                <div style="font-weight:bold; color:#1976d2; font-size:14px;">${dia.roturas}</div>
                <div style="width:100%; background:linear-gradient(to top, #1976d2, #42a5f5); border-radius:4px 4px 0 0; height:${altura}px; min-height:10px; transition:all 0.3s;"></div>
                <div style="font-size:11px; color:#666; transform:rotate(-45deg); margin-top:8px;">${dia.fecha}</div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      
      <!-- Resumen de reparaciones -->
      <div style="background:#f5f5f5; padding:20px; border-radius:8px; margin-bottom:24px;">
        <h3 style="margin:0 0 16px 0; color:#333; font-size:18px;">üîß Estado de Reparaciones</h3>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:16px;">
          <div style="background:white; padding:16px; border-radius:6px; text-align:center; border-top:4px solid #4caf50;">
            <div style="font-size:28px; font-weight:bold; color:#4caf50; margin-bottom:4px;">${stats.roturasReparadas}</div>
            <div style="font-size:13px; color:#666;">Roturas Reparadas</div>
          </div>
          <div style="background:white; padding:16px; border-radius:6px; text-align:center; border-top:4px solid #ff9800;">
            <div style="font-size:28px; font-weight:bold; color:#ff9800; margin-bottom:4px;">${stats.roturasPendientes}</div>
            <div style="font-size:13px; color:#666;">Roturas Pendientes</div>
          </div>
          <div style="background:white; padding:16px; border-radius:6px; text-align:center; border-top:4px solid #2196f3;">
            <div style="font-size:28px; font-weight:bold; color:#2196f3; margin-bottom:4px;">${stats.anomaliasReparadas}</div>
            <div style="font-size:13px; color:#666;">Anomal√≠as Reparadas</div>
          </div>
          <div style="background:white; padding:16px; border-radius:6px; text-align:center; border-top:4px solid #f44336;">
            <div style="font-size:28px; font-weight:bold; color:#f44336; margin-bottom:4px;">${stats.anomaliasPendientes}</div>
            <div style="font-size:13px; color:#666;">Anomal√≠as Pendientes</div>
          </div>
        </div>
      </div>
      
      <button id="cerrarStats" style="width:100%; padding:12px; background:#757575; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">‚úñÔ∏è Cerrar</button>
    `;
    
    modal.appendChild(contenido);
    document.body.appendChild(modal);
    
    contenido.querySelector('#cerrarStats').addEventListener('click', () => {
      modal.remove();
    });
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    
  } catch (e) {
    alert('‚ùå Error al generar estad√≠sticas');
    console.error(e);
  }
}

// Funci√≥n para analizar datos de los informes
function analizarDatosInformes(informes) {
  const stats = {
    totalInformes: informes.length,
    totalRoturas: 0,
    totalAnomalias: 0,
    roturasReparadas: 0,
    roturasPendientes: 0,
    anomaliasReparadas: 0,
    anomaliasPendientes: 0,
    areasMasProblematicas: [],
    tendenciaDias: [],
    promedioRoturas: 0
  };
  
  const areasMap = {};
  const fechasMap = {};
  
  informes.forEach(informe => {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = informe.contenido;
    
    // Buscar tabla de bit√°cora
    const tabla = tempDiv.querySelector('.tabla-bitacora tbody');
    if (tabla) {
      tabla.querySelectorAll('tr').forEach(fila => {
        const celdas = fila.querySelectorAll('td');
        if (celdas.length >= 9) {
          const fecha = celdas[1].textContent.trim();
          const area = celdas[2].textContent.trim();
          const rotInf = parseInt(celdas[3].textContent.trim()) || 0;
          const rotRep = parseInt(celdas[4].textContent.trim()) || 0;
          const rotPen = parseInt(celdas[5].textContent.trim()) || 0;
          const objInf = parseInt(celdas[6].textContent.trim()) || 0;
          const objRep = parseInt(celdas[7].textContent.trim()) || 0;
          const objPen = parseInt(celdas[8].textContent.trim()) || 0;
          
          if (rotInf > 0 || objInf > 0 || area) {
            stats.totalRoturas += rotInf;
            stats.totalAnomalias += objInf;
            stats.roturasReparadas += rotRep;
            stats.roturasPendientes += rotPen;
            stats.anomaliasReparadas += objRep;
            stats.anomaliasPendientes += objPen;
            
            // Contabilizar √°reas
            if (area) {
              areasMap[area] = (areasMap[area] || 0) + rotInf + objInf;
            }
            
            // Tendencia por fecha
            if (fecha) {
              fechasMap[fecha] = (fechasMap[fecha] || 0) + rotInf;
            }
          }
        }
      });
    }
  });
  
  // Procesar √°reas m√°s problem√°ticas
  stats.areasMasProblematicas = Object.entries(areasMap)
    .map(([nombre, incidencias]) => ({ nombre, incidencias }))
    .sort((a, b) => b.incidencias - a.incidencias);
  
  // Procesar tendencia por d√≠as
  stats.tendenciaDias = Object.entries(fechasMap)
    .map(([fecha, roturas]) => ({ fecha, roturas }))
    .sort((a, b) => a.fecha.localeCompare(b.fecha));
  
  // Calcular promedio
  stats.promedioRoturas = stats.tendenciaDias.length > 0 
    ? (stats.totalRoturas / stats.tendenciaDias.length).toFixed(1)
    : 0;
  
  return stats;
}

// ========== SISTEMA DE RECORDATORIOS ==========

// Obtener todos los recordatorios activos
function obtenerRecordatorios() {
  return JSON.parse(localStorage.getItem('recordatorios') || '[]');
}

// Guardar recordatorios
function guardarRecordatorios(recordatorios) {
  localStorage.setItem('recordatorios', JSON.stringify(recordatorios));
  actualizarBadgeRecordatorios();
}

// Actualizar badge de notificaciones
function actualizarBadgeRecordatorios() {
  if (!badgeRecordatorios) return;
  
  const recordatorios = obtenerRecordatorios();
  const activos = recordatorios.filter(r => !r.completado);
  
  if (activos.length > 0) {
    badgeRecordatorios.textContent = activos.length;
    badgeRecordatorios.style.display = 'block';
  } else {
    badgeRecordatorios.style.display = 'none';
  }
}

// Generar recordatorios autom√°ticos desde las bit√°coras
function generarRecordatoriosAutomaticos() {
  const informes = JSON.parse(localStorage.getItem('informesGuardados') || '[]');
  const recordatoriosExistentes = obtenerRecordatorios();
  const nuevosRecordatorios = [];
  
  informes.forEach(informe => {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = informe.contenido;
    
    // Extraer centro de cultivo y jaula del encabezado
    let centroCultivo = '';
    let jaula = '';
    
    const inputCentro = tempDiv.querySelector('.sync-centro');
    if (inputCentro) {
      centroCultivo = inputCentro.value || inputCentro.textContent.trim();
    }
    
    const inputArea = tempDiv.querySelector('.sync-area');
    if (inputArea) {
      const areaTexto = inputArea.value || inputArea.textContent.trim();
      const match = areaTexto.match(/JAULA N\.¬∫(\d+)/i);
      if (match) {
        jaula = match[1];
      }
    }
    
    const tabla = tempDiv.querySelector('.tabla-bitacora tbody');
    if (tabla) {
      tabla.querySelectorAll('tr').forEach(fila => {
        const celdas = fila.querySelectorAll('td');
        if (celdas.length >= 9) {
          const fecha = celdas[1].textContent.trim();
          const area = celdas[2].textContent.trim();
          const rotPen = parseInt(celdas[5].textContent.trim()) || 0;
          const objPen = parseInt(celdas[8].textContent.trim()) || 0;
          
          if (rotPen > 0 || objPen > 0) {
            const recordatorioId = `${informe.nombre}-${area}-${fecha}`;
            
            // Verificar si ya existe
            const yaExiste = recordatoriosExistentes.some(r => r.id === recordatorioId);
            if (!yaExiste) {
              nuevosRecordatorios.push({
                id: recordatorioId,
                tipo: rotPen > 0 && objPen > 0 ? 'ambos' : (rotPen > 0 ? 'rotura' : 'anomalia'),
                area: area,
                centroCultivo: centroCultivo,
                jaula: jaula,
                fecha: fecha,
                roturasP: rotPen,
                anomaliasP: objPen,
                informe: informe.nombre,
                creado: new Date().toISOString(),
                completado: false,
                prioridad: (rotPen + objPen) > 5 ? 'alta' : (rotPen + objPen) > 2 ? 'media' : 'baja'
              });
            }
          }
        }
      });
    }
  });
  
  if (nuevosRecordatorios.length > 0) {
    const todosRecordatorios = [...recordatoriosExistentes, ...nuevosRecordatorios];
    guardarRecordatorios(todosRecordatorios);
  }
  
  return nuevosRecordatorios.length;
}

// Ver panel de recordatorios
function verPanelRecordatorios() {
  const recordatorios = obtenerRecordatorios();
  
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;';
  
  const contenido = document.createElement('div');
  contenido.style.cssText = 'background:#fff; padding:30px; border-radius:12px; max-width:900px; width:100%; max-height:85vh; overflow-y:auto;';
  
  function renderizarRecordatorios() {
    const recordatoriosActualizados = obtenerRecordatorios();
    const activos = recordatoriosActualizados.filter(r => !r.completado);
    const completados = recordatoriosActualizados.filter(r => r.completado);
    
    contenido.innerHTML = `
      <h2 style="margin:0 0 24px 0; color:#1976d2; display:flex; align-items:center; justify-content:space-between;">
        <span style="display:flex; align-items:center; gap:12px;">
          <span style="font-size:32px;">üîî</span>
          Recordatorios de Reparaciones
        </span>
        <button id="generarNuevos" style="padding:8px 16px; background:#4caf50; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">üîÑ Escanear Informes</button>
      </h2>
      
      <!-- Filtros -->
      <div style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
        <button class="filtro-btn active" data-filtro="todos" style="padding:8px 16px; background:#1976d2; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">Todos (${activos.length})</button>
        <button class="filtro-btn" data-filtro="alta" style="padding:8px 16px; background:#f5f5f5; color:#333; border:1px solid #ddd; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">üî¥ Alta (${activos.filter(r => r.prioridad === 'alta').length})</button>
        <button class="filtro-btn" data-filtro="media" style="padding:8px 16px; background:#f5f5f5; color:#333; border:1px solid #ddd; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">üü† Media (${activos.filter(r => r.prioridad === 'media').length})</button>
        <button class="filtro-btn" data-filtro="baja" style="padding:8px 16px; background:#f5f5f5; color:#333; border:1px solid #ddd; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">üü¢ Baja (${activos.filter(r => r.prioridad === 'baja').length})</button>
        <button class="filtro-btn" data-filtro="completados" style="padding:8px 16px; background:#f5f5f5; color:#333; border:1px solid #ddd; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">‚úÖ Completados (${completados.length})</button>
      </div>
      
      <!-- Lista de recordatorios -->
      <div id="listaRecordatorios" style="display:flex; flex-direction:column; gap:12px; margin-bottom:20px;">
        ${activos.length === 0 ? `
          <div style="text-align:center; padding:40px 20px; color:#999;">
            <div style="font-size:48px; margin-bottom:12px;">‚úÖ</div>
            <div style="font-size:16px;">No hay recordatorios pendientes</div>
            <div style="font-size:14px; margin-top:8px;">Haz clic en "Escanear Informes" para buscar reparaciones pendientes</div>
          </div>
        ` : activos.map(r => crearHTMLRecordatorio(r)).join('')}
      </div>
      
      <button id="cerrarRecordatorios" style="width:100%; padding:12px; background:#757575; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">‚úñÔ∏è Cerrar</button>
    `;
    
    // Event listeners para filtros
    contenido.querySelectorAll('.filtro-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        contenido.querySelectorAll('.filtro-btn').forEach(b => {
          b.style.background = '#f5f5f5';
          b.style.color = '#333';
          b.style.border = '1px solid #ddd';
          b.classList.remove('active');
        });
        btn.style.background = '#1976d2';
        btn.style.color = 'white';
        btn.style.border = 'none';
        btn.classList.add('active');
        
        const filtro = btn.dataset.filtro;
        aplicarFiltro(filtro);
      });
    });
    
    // Bot√≥n generar nuevos
    contenido.querySelector('#generarNuevos').addEventListener('click', () => {
      const nuevos = generarRecordatoriosAutomaticos();
      if (nuevos > 0) {
        mostrarNotificacion(`‚úÖ Se generaron ${nuevos} recordatorios nuevos`, 3000);
        renderizarRecordatorios();
      } else {
        mostrarNotificacion('‚ÑπÔ∏è No se encontraron nuevas reparaciones pendientes', 3000);
      }
    });
    
    // Event listeners para acciones
    contenido.querySelectorAll('.btn-completar').forEach(btn => {
      btn.addEventListener('click', () => {
        const recordatorioId = btn.dataset.id;
        marcarRecordatorioCompletado(recordatorioId);
        renderizarRecordatorios();
      });
    });
    
    contenido.querySelectorAll('.btn-eliminar-rec').forEach(btn => {
      btn.addEventListener('click', () => {
        const recordatorioId = btn.dataset.id;
        eliminarRecordatorio(recordatorioId);
        renderizarRecordatorios();
      });
    });
    
    contenido.querySelector('#cerrarRecordatorios').addEventListener('click', () => {
      modal.remove();
    });
  }
  
  function aplicarFiltro(filtro) {
    const recordatorios = obtenerRecordatorios();
    let filtrados = [];
    
    if (filtro === 'todos') {
      filtrados = recordatorios.filter(r => !r.completado);
    } else if (filtro === 'completados') {
      filtrados = recordatorios.filter(r => r.completado);
    } else {
      filtrados = recordatorios.filter(r => !r.completado && r.prioridad === filtro);
    }
    
    const lista = contenido.querySelector('#listaRecordatorios');
    if (filtrados.length === 0) {
      lista.innerHTML = `
        <div style="text-align:center; padding:40px 20px; color:#999;">
          <div style="font-size:48px; margin-bottom:12px;">üì≠</div>
          <div style="font-size:16px;">No hay recordatorios en esta categor√≠a</div>
        </div>
      `;
    } else {
      lista.innerHTML = filtrados.map(r => crearHTMLRecordatorio(r)).join('');
      
      // Re-attach event listeners
      lista.querySelectorAll('.btn-completar').forEach(btn => {
        btn.addEventListener('click', () => {
          marcarRecordatorioCompletado(btn.dataset.id);
          renderizarRecordatorios();
        });
      });
      
      lista.querySelectorAll('.btn-eliminar-rec').forEach(btn => {
        btn.addEventListener('click', () => {
          eliminarRecordatorio(btn.dataset.id);
          renderizarRecordatorios();
        });
      });
    }
  }
  
  function crearHTMLRecordatorio(r) {
    const colorPrioridad = r.prioridad === 'alta' ? '#f44336' : (r.prioridad === 'media' ? '#ff9800' : '#4caf50');
    const iconoPrioridad = r.prioridad === 'alta' ? 'üî¥' : (r.prioridad === 'media' ? 'üü†' : 'üü¢');
    const diasDesde = Math.floor((new Date() - new Date(r.creado)) / (1000 * 60 * 60 * 24));
    
    return `
      <div style="background:#f5f5f5; padding:16px; border-radius:8px; border-left:4px solid ${colorPrioridad}; ${r.completado ? 'opacity:0.6;' : ''}">
        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
          <div style="flex:1;">
            <div style="font-weight:600; font-size:16px; color:#333; margin-bottom:4px;">
              ${iconoPrioridad} ${r.area}
              ${r.completado ? '<span style="background:#4caf50; color:white; padding:2px 8px; border-radius:12px; font-size:11px; margin-left:8px;">COMPLETADO</span>' : ''}
            </div>
            <div style="font-size:13px; color:#666; margin-bottom:8px;">
              ${r.centroCultivo ? `üè≠ ${r.centroCultivo}` : ''} ${r.jaula ? `‚Ä¢ üî¢ Jaula ${r.jaula}` : ''} ${r.centroCultivo || r.jaula ? '<br>' : ''}
              üìÖ ${r.fecha} ‚Ä¢ üìã ${r.informe}
            </div>
            <div style="display:flex; gap:16px; font-size:13px;">
              ${r.roturasP > 0 ? `<span style="color:#f44336; font-weight:600;">üîß ${r.roturasP} rotura${r.roturasP > 1 ? 's' : ''} pendiente${r.roturasP > 1 ? 's' : ''}</span>` : ''}
              ${r.anomaliasP > 0 ? `<span style="color:#ff9800; font-weight:600;">‚ö†Ô∏è ${r.anomaliasP} anomal√≠a${r.anomaliasP > 1 ? 's' : ''} pendiente${r.anomaliasP > 1 ? 's' : ''}</span>` : ''}
            </div>
            <div style="font-size:12px; color:#999; margin-top:4px;">
              ${r.completado ? `Completado hace ${Math.floor((new Date() - new Date(r.fechaCompletado)) / (1000 * 60 * 60 * 24))} d√≠a(s)` : `Creado hace ${diasDesde} d√≠a(s)`}
            </div>
          </div>
          <div style="display:flex; gap:8px;">
            ${!r.completado ? `
              <button class="btn-completar" data-id="${r.id}" style="padding:8px 12px; background:#4caf50; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600; white-space:nowrap;">‚úÖ Completar</button>
            ` : ''}
            <button class="btn-eliminar-rec" data-id="${r.id}" style="padding:8px 12px; background:#f44336; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;">üóëÔ∏è</button>
          </div>
        </div>
      </div>
    `;
  }
  
  renderizarRecordatorios();
  modal.appendChild(contenido);
  document.body.appendChild(modal);
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
}

// Marcar recordatorio como completado
function marcarRecordatorioCompletado(recordatorioId) {
  const recordatorios = obtenerRecordatorios();
  const recordatorio = recordatorios.find(r => r.id === recordatorioId);
  if (recordatorio) {
    recordatorio.completado = true;
    recordatorio.fechaCompletado = new Date().toISOString();
    guardarRecordatorios(recordatorios);
    mostrarNotificacion('‚úÖ Recordatorio marcado como completado', 2000);
  }
}

// Eliminar recordatorio
function eliminarRecordatorio(recordatorioId) {
  if (confirm('¬øEliminar este recordatorio?')) {
    const recordatorios = obtenerRecordatorios();
    const nuevosRecordatorios = recordatorios.filter(r => r.id !== recordatorioId);
    guardarRecordatorios(nuevosRecordatorios);
    mostrarNotificacion('üóëÔ∏è Recordatorio eliminado', 2000);
  }
}

// Event listeners
if (guardarInforme) {
  guardarInforme.addEventListener('click', guardarInformeDiario);
}

if (verConsolidado) {
  verConsolidado.addEventListener('click', verConsolidadoInformes);
}

if (verEstadisticas) {
  verEstadisticas.addEventListener('click', verEstadisticasInformes);
}

if (verRecordatorios) {
  verRecordatorios.addEventListener('click', verPanelRecordatorios);
}

if (exportarPDF) {
  exportarPDF.addEventListener('click', exportarInformeAPDF);
}

// Bot√≥n Nuevo Informe - limpia todo pero mantiene la bit√°cora
if (nuevoInforme) {
  nuevoInforme.addEventListener('click', () => {
    if (confirm('¬øCrear un nuevo informe? Esto limpiar√° el contenido actual pero mantendr√° los datos de la bit√°cora.')) {
      // Guardar la bit√°cora actual antes de limpiar
      guardarBitacora();
      
      // Limpiar el contenido del panel
      panelLineas.innerHTML = '';
      
      // Recrear la bit√°cora con los datos guardados
      asegurarBitacoraAlFinal();
      
      // Restaurar los datos de la bit√°cora
      setTimeout(() => {
        restaurarBitacora();
      }, 100);
      
      // Resetear el modo de edici√≥n si estaba activo
      if (guardarInforme.dataset.editandoIdx !== undefined) {
        delete guardarInforme.dataset.editandoIdx;
        guardarInforme.textContent = 'üíæ Guardar';
        guardarInforme.style.background = '';
      }
      
      alert('‚úÖ Nuevo informe iniciado. Los datos de la bit√°cora se han preservado.');
    }
  });
}

// Bot√≥n Agregar Texto al Esquema
if (agregarTextoEsquema) {
  agregarTextoEsquema.addEventListener('click', () => {
    const lineaFinal = document.querySelector('.linea-final');
    
    if (!lineaFinal) {
      alert('‚ö†Ô∏è Primero debes crear un informe con un esquema');
      return;
    }
    
    const cajaTexto = document.createElement('div');
    cajaTexto.className = 'caja-texto-esquema';
    cajaTexto.contentEditable = true;
    cajaTexto.textContent = 'Texto';
    cajaTexto.style.cssText = `
      position: absolute;
      top: 50px;
      left: 50px;
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid #1976d2;
      border-radius: 4px;
      padding: 4px 8px;
      min-width: 60px;
      max-width: 200px;
      font-size: 12px;
      cursor: move;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 100;
      word-wrap: break-word;
    `;
    
    const btnEliminar = document.createElement('button');
    btnEliminar.textContent = '√ó';
    btnEliminar.className = 'btn-eliminar-texto-esquema';
    btnEliminar.style.cssText = `
      position: absolute;
      top: -8px;
      right: -8px;
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 14px;
      cursor: pointer;
      display: none;
      line-height: 1;
      padding: 0;
    `;
    
    btnEliminar.addEventListener('click', (e) => {
      e.stopPropagation();
      cajaTexto.remove();
    });
    
    cajaTexto.appendChild(btnEliminar);
    
    // Mostrar/ocultar bot√≥n eliminar
    cajaTexto.addEventListener('mouseenter', () => {
      btnEliminar.style.display = 'block';
    });
    
    cajaTexto.addEventListener('mouseleave', () => {
      btnEliminar.style.display = 'none';
    });
    
    // Seleccionar todo el texto al hacer doble clic
    cajaTexto.addEventListener('dblclick', () => {
      const selection = window.getSelection();
      const range = document.createRange();
      range.selectNodeContents(cajaTexto);
      selection.removeAllRanges();
      selection.addRange(range);
    });
    
    // Hacer la caja arrastrable
    let isDragging = false;
    let offsetX, offsetY;
    
    cajaTexto.addEventListener('mousedown', (e) => {
      if (e.target === btnEliminar) return;
      
      // Si no est√° editando, permitir arrastre
      if (!cajaTexto.matches(':focus')) {
        isDragging = true;
        // Calcular offset relativo a la caja
        const rect = cajaTexto.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        cajaTexto.style.cursor = 'grabbing';
        e.preventDefault();
      }
    });
    
    const handleMouseMove = (e) => {
      if (isDragging) {
        const parentRect = lineaFinal.getBoundingClientRect();
        
        // Calcular nueva posici√≥n basada en la posici√≥n del mouse menos el offset
        let newLeft = e.clientX - parentRect.left - offsetX;
        let newTop = e.clientY - parentRect.top - offsetY;
        
        // Limitar dentro del contenedor
        newLeft = Math.max(0, Math.min(newLeft, parentRect.width - cajaTexto.offsetWidth));
        newTop = Math.max(0, Math.min(newTop, parentRect.height - cajaTexto.offsetHeight));
        
        cajaTexto.style.left = newLeft + 'px';
        cajaTexto.style.top = newTop + 'px';
      }
    };
    
    const handleMouseUp = () => {
      if (isDragging) {
        isDragging = false;
        cajaTexto.style.cursor = 'move';
      }
    };
    
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    
    // Prevenir arrastre cuando est√° en modo edici√≥n
    cajaTexto.addEventListener('focus', () => {
      cajaTexto.style.cursor = 'text';
    });
    
    cajaTexto.addEventListener('blur', () => {
      cajaTexto.style.cursor = 'move';
      if (cajaTexto.textContent.trim() === '') {
        cajaTexto.textContent = 'Texto';
      }
    });
    
    // Hacer la caja posicionable en toda la hoja (no solo dentro del esquema)
    const hojaContenedor = lineaFinal.closest('.hoja-fotos');
    if (hojaContenedor) {
      // Cambiar el contenedor padre para permitir posicionamiento en toda la hoja
      cajaTexto.remove();
      hojaContenedor.style.position = 'relative';
      hojaContenedor.appendChild(cajaTexto);
      
      // Actualizar el manejador de movimiento para el nuevo contenedor
      const handleMouseMoveGlobal = (e) => {
        if (isDragging) {
          const parentRect = hojaContenedor.getBoundingClientRect();
          const cajaRect = cajaTexto.getBoundingClientRect();
          
          let newLeft = e.clientX - parentRect.left - offsetX;
          let newTop = e.clientY - parentRect.top - offsetY;
          
          // Limitar dentro del contenedor de la hoja completa
          newLeft = Math.max(0, Math.min(newLeft, parentRect.width - cajaRect.width));
          newTop = Math.max(0, Math.min(newTop, parentRect.height - cajaRect.height));
          
          cajaTexto.style.left = newLeft + 'px';
          cajaTexto.style.top = newTop + 'px';
        }
      };
      
      document.removeEventListener('mousemove', handleMouseMove);
      document.addEventListener('mousemove', handleMouseMoveGlobal);
    } else {
      lineaFinal.appendChild(cajaTexto);
    }
  });
}

// Bot√≥n Cargar Fotos desde el Men√∫
if (cargarFotosMenu) {
  cargarFotosMenu.addEventListener('click', () => {
    // Buscar el input de fotos m√°s reciente (el que tiene multiple y est√° dentro de contenedor-cargar-fotos)
    const inputFotos = document.querySelector('.contenedor-cargar-fotos .input-file-hidden[multiple]');
    
    if (!inputFotos) {
      alert('‚ö†Ô∏è Primero debes crear un informe con un esquema');
      return;
    }
    
    // Simular click en el input de archivos
    inputFotos.click();
  });
}

// ========== FUNCI√ìN DE EXPORTACI√ìN A PDF ==========
function exportarInformeAPDF() {
  // Cerrar paneles si est√°n abiertos
  cerrarPaneles();
  
  // Ocultar el men√∫ lateral temporalmente
  const menuLateral = document.querySelector('.menu-lateral');
  const contenidoPrincipal = document.querySelector('.contenido-principal');
  const originalMargin = contenidoPrincipal.style.marginLeft;
  
  menuLateral.style.display = 'none';
  contenidoPrincipal.style.marginLeft = '0';
  
  // Dar tiempo para que se apliquen los cambios
  setTimeout(() => {
    window.print();
    
    // Restaurar despu√©s de imprimir
    setTimeout(() => {
      menuLateral.style.display = 'flex';
      contenidoPrincipal.style.marginLeft = originalMargin || '60px';
    }, 100);
  }, 100);
}

// ========== EDITOR DE RECORTE DE IMAGEN ==========
function mostrarEditorRecorte(imagenSrc, callback) {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;';
  
  const controles = document.createElement('div');
  controles.style.cssText = 'background:#fff; padding:16px; border-radius:8px; margin-bottom:16px; display:flex; gap:12px; align-items:center;';
  controles.innerHTML = `
    <button id="usarCompleta" style="padding:10px 16px; background:#4caf50; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600;">‚úì Usar imagen completa</button>
    <button id="recortarBtn" style="padding:10px 16px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600;">‚úÇÔ∏è Aplicar recorte</button>
    <button id="cancelarBtn" style="padding:10px 16px; background:#f44336; color:#fff; border:none; border-radius:6px; cursor:pointer;">‚úï Cancelar</button>
    <span style="margin-left:16px; color:#fff; font-weight:600;">Arrastra para seleccionar el √°rea a usar</span>
  `;
  
  const contenedorCanvas = document.createElement('div');
  contenedorCanvas.style.cssText = 'position:relative; max-width:90%; max-height:70vh; overflow:auto; background:#333; border-radius:8px; display:flex; align-items:center; justify-content:center;';
  
  const canvas = document.createElement('canvas');
  canvas.style.cssText = 'display:block; cursor:crosshair; max-width:100%; max-height:70vh; object-fit:contain;';
  const ctx = canvas.getContext('2d');
  
  contenedorCanvas.appendChild(canvas);
  modal.appendChild(controles);
  modal.appendChild(contenedorCanvas);
  document.body.appendChild(modal);
  
  // Cargar imagen
  const img = new Image();
  img.onload = () => {
    // Escalar la imagen para que quepa en la pantalla
    const maxWidth = window.innerWidth * 0.85;
    const maxHeight = window.innerHeight * 0.65;
    let escala = 1;
    
    if (img.width > maxWidth || img.height > maxHeight) {
      const escalaAncho = maxWidth / img.width;
      const escalaAlto = maxHeight / img.height;
      escala = Math.min(escalaAncho, escalaAlto);
    }
    
    const anchoCanvas = img.width * escala;
    const altoCanvas = img.height * escala;
    
    canvas.width = anchoCanvas;
    canvas.height = altoCanvas;
    canvas.style.width = anchoCanvas + 'px';
    canvas.style.height = altoCanvas + 'px';
    
    ctx.drawImage(img, 0, 0, anchoCanvas, altoCanvas);
    
    // Variables de selecci√≥n
    let seleccionando = false;
    let startX, startY, endX, endY;
    const imgOriginal = ctx.getImageData(0, 0, canvas.width, canvas.height);
    
    // Dibujar selecci√≥n
    function dibujarSeleccion() {
      ctx.putImageData(imgOriginal, 0, 0);
      if (startX !== undefined && startY !== undefined && endX !== undefined && endY !== undefined) {
        const x = Math.min(startX, endX);
        const y = Math.min(startY, endY);
        const w = Math.abs(endX - startX);
        const h = Math.abs(endY - startY);
        
        // Oscurecer √°rea no seleccionada
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.fillRect(0, 0, canvas.width, y); // Arriba
        ctx.fillRect(0, y, x, h); // Izquierda
        ctx.fillRect(x + w, y, canvas.width - (x + w), h); // Derecha
        ctx.fillRect(0, y + h, canvas.width, canvas.height - (y + h)); // Abajo
        
        // Marco de selecci√≥n
        ctx.strokeStyle = '#1976d2';
        ctx.lineWidth = 3;
        ctx.strokeRect(x, y, w, h);
      }
    }
    
    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      startX = (e.clientX - rect.left) * (canvas.width / rect.width);
      startY = (e.clientY - rect.top) * (canvas.height / rect.height);
      seleccionando = true;
    });
    
    canvas.addEventListener('mousemove', (e) => {
      if (!seleccionando) return;
      const rect = canvas.getBoundingClientRect();
      endX = (e.clientX - rect.left) * (canvas.width / rect.width);
      endY = (e.clientY - rect.top) * (canvas.height / rect.height);
      dibujarSeleccion();
    });
    
    canvas.addEventListener('mouseup', () => {
      seleccionando = false;
    });
    
    // Bot√≥n usar completa
    controles.querySelector('#usarCompleta').addEventListener('click', () => {
      modal.remove();
      callback(imagenSrc);
    });
    
    // Bot√≥n recortar
    controles.querySelector('#recortarBtn').addEventListener('click', () => {
      if (startX === undefined || endX === undefined) {
        alert('Por favor selecciona un √°rea primero');
        return;
      }
      
      const x = Math.min(startX, endX);
      const y = Math.min(startY, endY);
      const w = Math.abs(endX - startX);
      const h = Math.abs(endY - startY);
      
      if (w < 10 || h < 10) {
        alert('El √°rea seleccionada es muy peque√±a');
        return;
      }
      
      // Calcular coordenadas en imagen original
      const factorX = img.width / anchoCanvas;
      const factorY = img.height / altoCanvas;
      const xOriginal = x * factorX;
      const yOriginal = y * factorY;
      const wOriginal = w * factorX;
      const hOriginal = h * factorY;
      
      // Crear canvas temporal con el recorte en resoluci√≥n original
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = wOriginal;
      tempCanvas.height = hOriginal;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(img, xOriginal, yOriginal, wOriginal, hOriginal, 0, 0, wOriginal, hOriginal);
      
      const imagenRecortada = tempCanvas.toDataURL('image/png');
      modal.remove();
      callback(imagenRecortada);
    });
    
    // Bot√≥n cancelar
    controles.querySelector('#cancelarBtn').addEventListener('click', () => {
      modal.remove();
    });
  };
  
  img.src = imagenSrc;
}

// ========== AUTOGUARDADO CADA 5 MINUTOS ==========
let autoguardadoActivo = true;
let ultimoAutoguardado = Date.now();

function autoguardarDatos() {
  if (!autoguardadoActivo) return;
  
  try {
    // Guardar bit√°cora autom√°ticamente
    sincronizarBitacoraAlDOM();
    guardarBitacora();
    
    // Guardar estado actual del panel (borrador)
    const borrador = {
      contenido: panelLineas.innerHTML,
      timestamp: Date.now(),
      piloto: settings.pilotoDefault,
      fecha: settings.fechaDefault
    };
    
    localStorage.setItem('borradorAutoguardado', JSON.stringify(borrador));
    ultimoAutoguardado = Date.now();
    
    // Mostrar indicador visual discreto
    mostrarNotificacion('üíæ Autoguardado', 2000);
    
    console.log('‚úÖ Autoguardado completado:', new Date().toLocaleTimeString());
  } catch (e) {
    console.error('Error en autoguardado:', e);
  }
}

// Ejecutar autoguardado cada 5 minutos (300000 ms)
setInterval(autoguardarDatos, 300000);

// Funci√≥n para mostrar notificaciones discretas
function mostrarNotificacion(mensaje, duracion = 3000) {
  const notif = document.createElement('div');
  notif.textContent = mensaje;
  notif.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4caf50;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease;
  `;
  
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notif.remove(), 300);
  }, duracion);
}

// Agregar estilos de animaci√≥n
const styleSheet = document.createElement('style');
styleSheet.textContent = `
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
`;
document.head.appendChild(styleSheet);

// Recuperar borrador al cargar la p√°gina
window.addEventListener('DOMContentLoaded', () => {
  const borrador = localStorage.getItem('borradorAutoguardado');
  if (borrador) {
    try {
      const datos = JSON.parse(borrador);
      const tiempoTranscurrido = Date.now() - datos.timestamp;
      
      // Si el borrador tiene menos de 24 horas
      if (tiempoTranscurrido < 86400000) {
        const recuperar = confirm('üìã Se detect√≥ un borrador autoguardado. ¬øDeseas recuperarlo?');
        if (recuperar && datos.contenido) {
          panelLineas.innerHTML = datos.contenido;
          restaurarBitacora();
          mostrarNotificacion('‚úÖ Borrador recuperado', 3000);
        }
      } else {
        // Limpiar borradores antiguos
        localStorage.removeItem('borradorAutoguardado');
      }
    } catch (e) {
      console.error('Error al recuperar borrador:', e);
    }
  }
});

// ========== INICIALIZACI√ìN ==========
// Actualizar badge de recordatorios al cargar
actualizarBadgeRecordatorios();

// Generar recordatorios autom√°ticamente cada vez que se carga la p√°gina
setTimeout(() => {
  const nuevos = generarRecordatoriosAutomaticos();
  if (nuevos > 0) {
    mostrarNotificacion(`üîî ${nuevos} nuevo${nuevos > 1 ? 's' : ''} recordatorio${nuevos > 1 ? 's' : ''} generado${nuevos > 1 ? 's' : ''}`, 4000);
  }
}, 2000);

// ========== MODO OFFLINE AVANZADO - PWA ==========

// Registrar Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then((registration) => {
        console.log('‚úÖ Service Worker registrado:', registration.scope);
        
        // Verificar actualizaciones del Service Worker
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('üîÑ Nueva versi√≥n del Service Worker disponible');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Nueva versi√≥n disponible
              if (confirm('üì¶ Nueva versi√≥n disponible. ¬øRecargar para actualizar?')) {
                newWorker.postMessage({ action: 'skipWaiting' });
                window.location.reload();
              }
            }
          });
        });
        
        // Mostrar notificaci√≥n de PWA lista
        setTimeout(() => {
          mostrarPWAStatus();
        }, 1000);
      })
      .catch((error) => {
        console.error('‚ùå Error al registrar Service Worker:', error);
      });
  });
  
  // Escuchar cambios en el controller (nuevo SW activo)
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    console.log('üîÑ Service Worker actualizado');
  });
}

// Detectar estado online/offline
const offlineIndicator = document.getElementById('offlineIndicator');

function actualizarEstadoConexion() {
  if (!offlineIndicator) return;
  
  if (navigator.onLine) {
    offlineIndicator.classList.add('online');
    offlineIndicator.classList.remove('oculto');
    offlineIndicator.querySelector('.offline-icon').textContent = '‚úÖ';
    offlineIndicator.querySelector('.offline-text').textContent = 'Modo Online';
    
    // Ocultar despu√©s de 3 segundos
    setTimeout(() => {
      offlineIndicator.classList.add('oculto');
    }, 3000);
  } else {
    offlineIndicator.classList.remove('online');
    offlineIndicator.classList.remove('oculto');
    offlineIndicator.querySelector('.offline-icon').textContent = '‚ö†Ô∏è';
    offlineIndicator.querySelector('.offline-text').textContent = 'Modo Offline';
  }
}

window.addEventListener('online', () => {
  console.log('‚úÖ Conexi√≥n restaurada');
  actualizarEstadoConexion();
  mostrarNotificacion('‚úÖ Conexi√≥n restaurada', 3000);
});

window.addEventListener('offline', () => {
  console.log('‚ö†Ô∏è Sin conexi√≥n - Modo Offline');
  actualizarEstadoConexion();
  mostrarNotificacion('‚ö†Ô∏è Trabajando sin conexi√≥n', 3000);
});

// Verificar estado inicial
if (!navigator.onLine && offlineIndicator) {
  actualizarEstadoConexion();
}

// Mostrar panel de estado PWA
function mostrarPWAStatus() {
  const pwaStatus = document.getElementById('pwaStatus');
  if (!pwaStatus) return;
  
  pwaStatus.classList.remove('oculto');
  
  const closeBtn = document.getElementById('closePwaStatus');
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      pwaStatus.classList.add('oculto');
    });
  }
  
  // Auto-ocultar despu√©s de 8 segundos
  setTimeout(() => {
    pwaStatus.classList.add('oculto');
  }, 8000);
}

// Instalaci√≥n de PWA
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  console.log('üì± PWA puede ser instalada');
  e.preventDefault();
  deferredPrompt = e;
  
  // Mostrar bot√≥n de instalaci√≥n
  mostrarBotonInstalar();
});

function mostrarBotonInstalar() {
  const btnInstalar = document.createElement('button');
  btnInstalar.id = 'installPwaBtn';
  btnInstalar.className = 'install-pwa-btn';
  btnInstalar.innerHTML = 'üì± Instalar Aplicaci√≥n';
  btnInstalar.style.display = 'block';
  
  btnInstalar.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    console.log(`Usuario ${outcome === 'accepted' ? 'acept√≥' : 'rechaz√≥'} la instalaci√≥n`);
    
    if (outcome === 'accepted') {
      mostrarNotificacion('‚úÖ Aplicaci√≥n instalada correctamente', 3000);
    }
    
    deferredPrompt = null;
    btnInstalar.style.display = 'none';
  });
  
  document.body.appendChild(btnInstalar);
  
  // Auto-ocultar despu√©s de 15 segundos
  setTimeout(() => {
    btnInstalar.style.display = 'none';
  }, 15000);
}

window.addEventListener('appinstalled', () => {
  console.log('‚úÖ PWA instalada exitosamente');
  mostrarNotificacion('‚úÖ Aplicaci√≥n instalada - Ahora puedes usarla offline', 4000);
  deferredPrompt = null;
});

// Gesti√≥n de cache desde la interfaz
function obtenerEstadoCache() {
  if (!navigator.serviceWorker.controller) {
    return Promise.resolve({ cached: 0, total: 0 });
  }
  
  return new Promise((resolve) => {
    const messageChannel = new MessageChannel();
    messageChannel.port1.onmessage = (event) => {
      resolve(event.data);
    };
    
    navigator.serviceWorker.controller.postMessage(
      { action: 'getCacheStatus' },
      [messageChannel.port2]
    );
  });
}

function limpiarCache() {
  if (!navigator.serviceWorker.controller) {
    alert('‚ö†Ô∏è Service Worker no est√° activo');
    return;
  }
  
  if (confirm('¬øLimpiar toda la cach√© de la aplicaci√≥n?\n\nEsto eliminar√° los recursos guardados para uso offline.')) {
    const messageChannel = new MessageChannel();
    messageChannel.port1.onmessage = (event) => {
      if (event.data.success) {
        mostrarNotificacion('‚úÖ Cach√© limpiada correctamente', 3000);
        setTimeout(() => {
          if (confirm('Se recomienda recargar la p√°gina. ¬øRecargar ahora?')) {
            location.reload();
          }
        }, 1000);
      }
    };
    
    navigator.serviceWorker.controller.postMessage(
      { action: 'clearCache' },
      [messageChannel.port2]
    );
  }
}

// ========== SISTEMA DE SINCRONIZACI√ìN EN SEGUNDO PLANO ==========

// Cola de sincronizaci√≥n
let colaSincronizacion = JSON.parse(localStorage.getItem('colaSincronizacion') || '[]');

// Guardar cola en localStorage
function guardarColaSincronizacion() {
  localStorage.setItem('colaSincronizacion', JSON.stringify(colaSincronizacion));
  actualizarContadorColaSincronizacion();
}

// Agregar operaci√≥n a la cola de sincronizaci√≥n
function agregarAColaSincronizacion(operacion) {
  const item = {
    id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
    timestamp: new Date().toISOString(),
    intentos: 0,
    maxIntentos: 3,
    ...operacion
  };
  
  colaSincronizacion.push(item);
  guardarColaSincronizacion();
  
  console.log('üìù Operaci√≥n agregada a cola de sincronizaci√≥n:', item.type);
  
  // Intentar sincronizar inmediatamente si hay conexi√≥n
  if (navigator.onLine) {
    registrarSincronizacion();
  }
  
  return item.id;
}

// Registrar sincronizaci√≥n con Service Worker
async function registrarSincronizacion() {
  if ('serviceWorker' in navigator && 'SyncManager' in window) {
    try {
      const registration = await navigator.serviceWorker.ready;
      await registration.sync.register('sync-informes');
      console.log('‚úÖ Sincronizaci√≥n registrada');
    } catch (error) {
      console.error('‚ùå Error al registrar sincronizaci√≥n:', error);
      // Fallback: intentar sincronizar directamente
      procesarColaSincronizacionDirecta();
    }
  } else {
    // Fallback para navegadores sin Background Sync
    procesarColaSincronizacionDirecta();
  }
}

// Procesar cola de sincronizaci√≥n directamente (fallback)
async function procesarColaSincronizacionDirecta() {
  if (!navigator.onLine) {
    console.log('‚ö†Ô∏è Sin conexi√≥n - sincronizaci√≥n pospuesta');
    return;
  }
  
  if (colaSincronizacion.length === 0) {
    console.log('‚úÖ No hay operaciones pendientes de sincronizaci√≥n');
    return;
  }
  
  console.log(`üì§ Procesando ${colaSincronizacion.length} operaciones pendientes...`);
  
  const operacionesProcesadas = [];
  const operacionesFallidas = [];
  
  for (const item of colaSincronizacion) {
    try {
      await procesarOperacionSincronizacion(item);
      operacionesProcesadas.push(item);
      console.log('‚úÖ Operaci√≥n sincronizada:', item.id);
    } catch (error) {
      console.error('‚ùå Error al sincronizar operaci√≥n:', item.id, error);
      item.intentos++;
      
      if (item.intentos >= item.maxIntentos) {
        operacionesFallidas.push(item);
        console.error('‚ùå Operaci√≥n descartada tras m√∫ltiples intentos:', item.id);
      }
    }
  }
  
  // Remover operaciones procesadas y fallidas
  colaSincronizacion = colaSincronizacion.filter(
    item => !operacionesProcesadas.includes(item) && !operacionesFallidas.includes(item)
  );
  
  guardarColaSincronizacion();
  
  // Mostrar resultado
  if (operacionesProcesadas.length > 0) {
    mostrarNotificacion(`‚úÖ ${operacionesProcesadas.length} operaci√≥n(es) sincronizada(s)`, 3000);
  }
  
  if (operacionesFallidas.length > 0) {
    mostrarNotificacion(`‚ö†Ô∏è ${operacionesFallidas.length} operaci√≥n(es) fallaron`, 3000);
  }
}

// Procesar una operaci√≥n individual
async function procesarOperacionSincronizacion(operacion) {
  // Simulaci√≥n de env√≠o a servidor
  // En producci√≥n, aqu√≠ ir√≠a la llamada real a la API
  
  console.log('üì§ Enviando al servidor:', operacion.type, operacion.data);
  
  // Ejemplo de c√≥mo ser√≠a con backend real:
  /*
  const response = await fetch('https://tu-api.com/api/sync', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer tu-token'
    },
    body: JSON.stringify(operacion)
  });
  
  if (!response.ok) {
    throw new Error(`Error HTTP: ${response.status}`);
  }
  
  return await response.json();
  */
  
  // Simulaci√≥n de √©xito
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve({ success: true, syncedAt: new Date().toISOString() });
    }, 500);
  });
}

// Actualizar contador de cola de sincronizaci√≥n
function actualizarContadorColaSincronizacion() {
  const contador = document.getElementById('contadorColaSinc');
  if (contador) {
    const pendientes = colaSincronizacion.length;
    if (pendientes > 0) {
      contador.textContent = pendientes;
      contador.style.display = 'inline-block';
    } else {
      contador.style.display = 'none';
    }
  }
}

// Ver estado de sincronizaci√≥n
function verEstadoSincronizacion() {
  const pendientes = colaSincronizacion.length;
  const ultimaSinc = localStorage.getItem('ultimaSincronizacion');
  
  let mensaje = `üìä Estado de Sincronizaci√≥n\n\n`;
  mensaje += `üìù Operaciones pendientes: ${pendientes}\n`;
  
  if (ultimaSinc) {
    const fecha = new Date(ultimaSinc);
    mensaje += `‚úÖ √öltima sincronizaci√≥n: ${fecha.toLocaleString()}\n`;
  } else {
    mensaje += `‚úÖ √öltima sincronizaci√≥n: Nunca\n`;
  }
  
  mensaje += `\nüåê Estado de conexi√≥n: ${navigator.onLine ? '‚úÖ Online' : '‚ö†Ô∏è Offline'}`;
  
  if (pendientes > 0) {
    mensaje += `\n\nüìã Operaciones en cola:\n`;
    colaSincronizacion.slice(0, 5).forEach((op, idx) => {
      mensaje += `\n${idx + 1}. ${op.type} (${op.intentos}/${op.maxIntentos} intentos)`;
    });
    
    if (pendientes > 5) {
      mensaje += `\n... y ${pendientes - 5} m√°s`;
    }
  }
  
  alert(mensaje);
}

// Forzar sincronizaci√≥n manual
async function forzarSincronizacion() {
  if (!navigator.onLine) {
    alert('‚ö†Ô∏è No hay conexi√≥n a internet.\n\nLa sincronizaci√≥n se ejecutar√° autom√°ticamente cuando se recupere la conexi√≥n.');
    return;
  }
  
  if (colaSincronizacion.length === 0) {
    alert('‚úÖ No hay operaciones pendientes de sincronizaci√≥n.');
    return;
  }
  
  if (confirm(`¬øSincronizar ${colaSincronizacion.length} operaci√≥n(es) pendiente(s)?`)) {
    mostrarNotificacion('üì§ Sincronizando...', 2000);
    await procesarColaSincronizacionDirecta();
    
    if (colaSincronizacion.length === 0) {
      localStorage.setItem('ultimaSincronizacion', new Date().toISOString());
    }
  }
}

// Limpiar cola de sincronizaci√≥n
function limpiarColaSincronizacion() {
  if (confirm('¬øEliminar todas las operaciones pendientes de sincronizaci√≥n?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.')) {
    colaSincronizacion = [];
    guardarColaSincronizacion();
    mostrarNotificacion('üóëÔ∏è Cola de sincronizaci√≥n limpiada', 2000);
  }
}

// Interceptar guardado de informes para agregar a cola
const guardarInformeDiarioOriginal = guardarInformeDiario;

// Escuchar mensajes del Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', (event) => {
    console.log('üì® Mensaje del Service Worker:', event.data);
    
    if (event.data.type === 'SYNC_COMPLETE') {
      console.log('‚úÖ Sincronizaci√≥n completada:', event.data.count, 'elementos');
      localStorage.setItem('ultimaSincronizacion', new Date().toISOString());
      mostrarNotificacion(`‚úÖ ${event.data.count} operaci√≥n(es) sincronizada(s)`, 3000);
      
      // Limpiar cola local despu√©s de sincronizaci√≥n exitosa
      colaSincronizacion = [];
      guardarColaSincronizacion();
    }
    
    if (event.data.type === 'OPERATIONS_SYNCED') {
      console.log('‚úÖ Operaciones procesadas:', event.data.count);
    }
  });
}

// Sincronizar autom√°ticamente cuando vuelve la conexi√≥n
window.addEventListener('online', () => {
  console.log('‚úÖ Conexi√≥n restaurada - iniciando sincronizaci√≥n autom√°tica');
  
  setTimeout(() => {
    if (colaSincronizacion.length > 0) {
      mostrarNotificacion(`üì§ Sincronizando ${colaSincronizacion.length} operaci√≥n(es) pendiente(s)...`, 2000);
      registrarSincronizacion();
    }
  }, 1000);
});

// Actualizar contador al cargar
actualizarContadorColaSincronizacion();

// Solicitar permisos de notificaciones (opcional)
function solicitarPermisoNotificaciones() {
  if (!('Notification' in window)) {
    console.log('‚ùå Este navegador no soporta notificaciones');
    return;
  }
  
  if (Notification.permission === 'default') {
    Notification.requestPermission().then((permission) => {
      if (permission === 'granted') {
        console.log('‚úÖ Permiso de notificaciones concedido');
        mostrarNotificacion('‚úÖ Notificaciones activadas', 3000);
      }
    });
  }
}

// Llamar despu√©s de unos segundos (opcional, no intrusivo)
setTimeout(() => {
  if ('Notification' in window && Notification.permission === 'default') {
    // No solicitar autom√°ticamente, dejar que el usuario lo active si lo desea
  }
}, 5000);

console.log('üöÄ Sistema de modo offline avanzado inicializado');


